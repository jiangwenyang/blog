<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Jiang Wenyang's Blog</title>
        <link>https://jiangwenyang.com</link>
        <description>Jiang Wenyang's Blog</description>
        <lastBuildDate>Thu, 19 May 2022 07:48:43 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>Feed for Node.js</generator>
        <language>zh</language>
        <image>
            <title>Jiang Wenyang's Blog</title>
            <url>https://jiangwenyang.com/logo.svg</url>
            <link>https://jiangwenyang.com</link>
        </image>
        <copyright>All rights reserved 2022, Jiang Wenyang</copyright>
        <item>
            <title><![CDATA[一个真实的Vue CLI项目迁移到vite]]></title>
            <link>https://jiangwenyang.com/posts/一个真实的vue-cli项目迁移到vite</link>
            <guid>https://jiangwenyang.com/posts/一个真实的vue-cli项目迁移到vite</guid>
            <pubDate>Wed, 22 Sep 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[需要迁移到Vite的理由，并以真实项目为例，详细介绍从vue-cli迁移到Vite的可能会遇到的问题，以及如何解决这些问题]]></description>
            <content:encoded><![CDATA[
<h2 id="toc">TOC</h2>
<ul>
  <li>
    <p><a href="#%E6%98%AF%E8%B0%81%E5%8F%AB%E4%BB%80%E4%B9%88%E6%9D%A5%E8%87%AA%E5%93%AA%E9%87%8C%E8%A6%81%E5%8E%BB%E5%BE%80%E9%82%A3%E9%87%8C">是谁？叫什么？来自哪里？要去往那里？</a></p>
  </li>
  <li>
    <p><a href="#%E5%A5%BD%E5%A5%BD%E7%9A%84%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%BF%81%E7%A7%BB">好好的为什么要迁移？</a></p>
  </li>
  <li>
    <p><a href="#%E5%8D%83%E9%87%8C%E4%B9%8B%E8%A1%8C%E5%A7%8B%E4%BA%8E%E8%B6%B3%E4%B8%8B">千里之行始于足下</a></p>
    <ul>
      <li><a href="#%E9%A6%96%E5%85%88%E4%B8%A2%E6%8E%89%E5%8E%86%E5%8F%B2%E5%8C%85%E8%A2%B1%E7%A7%BB%E9%99%A4-vue-cli-%E8%BD%BB%E8%A3%85%E4%B8%8A%E9%98%B5">首先丢掉历史包袱，移除 Vue CLI 轻装上阵</a></li>
      <li><a href="#%E7%84%B6%E5%90%8E%E5%89%94%E4%B8%AA%E7%89%99%E5%81%9A%E4%BA%9B%E5%B0%8F%E6%94%B9%E5%8A%A8">然后剔个牙，做些“小改动”</a></li>
      <li><a href="#%E5%87%BA%E6%9D%A5%E5%90%A7%E4%BD%A0vite">出来吧你，Vite</a></li>
    </ul>
  </li>
  <li>
    <p><a href="#%E5%A1%AB%E5%9D%91%E4%B9%8B%E6%97%85">填坑之旅</a></p>
    <ul>
      <li><a href="#%E5%90%AF%E7%94%A8-jsx">启用 JSX</a></li>
      <li><a href="#alias">alias</a></li>
      <li><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%A3%E7%A0%81%E4%B8%AD%E4%B8%8D%E8%83%BD%E4%BD%BF%E7%94%A8-node-%E5%86%85%E9%83%A8%E6%A8%A1%E5%9D%97">客户端代码中不能使用 node 内部模块</a></li>
      <li><a href="#%E5%85%A8%E5%B1%80-css-%E5%8F%98%E9%87%8F">全局 CSS 变量</a></li>
      <li><a href="#%E5%8A%A8%E6%80%81%E5%AF%BC%E5%85%A5-png-%E7%AD%89%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90">动态导入 png 等图片资源</a></li>
      <li><a href="#svg-%E9%9B%AA%E7%A2%A7%E5%9B%BE">svg 雪碧图</a></li>
      <li><a href="#glob-%E5%AF%BC%E5%85%A5">Glob 导入</a></li>
      <li><a href="#%E7%83%AD%E6%9B%B4%E6%96%B0">热更新</a></li>
      <li><a href="#%E5%9C%A8-vite-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">在 Vite 配置文件中使用环境变量</a></li>
    </ul>
  </li>
  <li>
    <p><a href="#%E5%B0%8F%E7%94%9C%E5%93%81%E6%9D%A5%E7%82%B9%E5%B7%A5%E7%A8%8B%E5%8C%96%E4%BC%98%E5%8C%96">小甜品，来点工程化优化</a></p>
    <ul>
      <li><a href="#huskylint-staged-%E5%AE%9E%E7%8E%B0%E6%8F%90%E4%BA%A4-lint">husky+lint-staged 实现提交 lint</a></li>
    </ul>
  </li>
  <li>
    <p><a href="#%E5%AE%8C%E6%95%B4%E5%9C%B0%E5%9B%BE">完整地图</a></p>
  </li>
</ul>
<h2 id="是谁叫什么来自哪里要去往那里">是谁？叫什么？来自哪里？要去往那里？</h2>
<p>先来回答灵魂拷问。我们原有的项目是一个使用 Vue CLI 生成的 vue2 项目，项目整体上是没有什么大问题的，但是随着模块的不断增多，Vue CLI 基于 Webpack 构建速度越来越慢，开发体验上比较差，为了减少抓狂时间，我们将目光转向了号称很快的 Vite。</p>
<p>废话不多说，先来看原本的项目结构：</p>
<div class="remark-highlight">
  <pre class="language-unknown"><code class="language-unknown">├── .browserslistrc
├── .editorconfig
├── .env.development // 环境变量，以下几个文件同
├── .env.development.local
├── .env.pre
├── .env.production
├── .env.si
├── .env.test
├── .eslintignore
├── .eslintrc.js
├── .gitignore
├── .npmrc
├── .nvmrc
├── .prettierignore
├── .prettierrc.js
├── .stylelintignore
├── .stylelintrc.js
├── README.md
├── babel.config.js
├── build/
├── config/ 一些项目配置文件，如代理配置等
├── dist/ 构建产物
├── doc/ 开发文档
├── jsconfig.json
├── mock/
├── package.json
├── postcss.config.js
├── public/
├── src/ 业务相关
├── tests/
├── vue.config.js // Vue CLI配置
└── yarn.lock</code></pre>
</div>
<h2 id="好好的为什么要迁移">好好的为什么要迁移？</h2>
<p>迁移的目的主要是构建速度上的差别，除此之外 Vite 也有一些其他的优势。</p>
<ul>
  <li>
    <p>构建速度</p>
    <p>Vite 相比 Vue CLI 最显著的优势应该就是构建速度了，Vite 基于 esbuild 预构建依赖，因此会快很多，开发体验会更好。</p>
    <blockquote>
      <p>Vite 的开发环境和生产环境构建目前有所区别，开发环境因为直接使用原生 ESM 不需要打包，而生产环境打包采用了 Rollup</p>
    </blockquote>
  </li>
  <li>
    <p>隐藏技术细节</p>
    <p>呃，这一点，其实 vite 和 Vue CLI 没有太大区别。。。</p>
  </li>
  <li>
    <p>折腾，尝试新的工具</p>
    <p>毕竟是新的工具，尝试一下，并且 Vue 社区目前也是在推动的。</p>
  </li>
</ul>
<h2 id="千里之行始于足下">千里之行始于足下</h2>
<p>万事开头难，既然迁移的 Flag 已经立了，只能硬着头皮上了。让我们先简单看一遍 Vite 的官方文档，文档延续了 Vue 官方文档简洁清晰的优点，基本上简单看一遍就对 Vite 比较了解了，具体细节不比过分深究。看完文档很容易发现和 Vue CLI 的一些约定上的区别，对于这部分是必须修改代码的，下面开始迁移</p>
<h3 id="首先丢掉历史包袱移除-vue-cli-轻装上阵">首先丢掉历史包袱，移除 Vue CLI 轻装上阵</h3>
<p>首先，我们先移除所有和 Vue CLI 相关的依赖以及配置</p>
<ul>
  <li>
    <p>在 <code>package.json</code> 的依赖中搜索 <code>vue-cli</code> 关键词，然后移除相关依赖。</p>
  </li>
  <li>
    <p>将 script 中的启动脚本改为 Vite 对应的启动脚本</p>
    <p>将原本的启动脚本</p>
    <div class="remark-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service serve --open"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"vue-cli-service build --mode development"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
    <p>改为</p>
    <div class="remark-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"vite"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"vite build"</span><span class="token punctuation">,</span>
    <span class="token property">"serve"</span><span class="token operator">:</span> <span class="token string">"vite preview"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
  </li>
</ul>
<h3 id="然后剔个牙做些小改动">然后剔个牙，做些“小改动”</h3>
<p>我们上面说到 Vite 和 Vue CLI 在部分约定上的不同，需要对代码做一些小改动</p>
<h4 id="入口不同">入口不同</h4>
<p>Vue CLI 默认入口为<code>src/main.js</code>，而 Vite 的默认入口则是 index.html</p>
<p>直接引用官方文档：</p>
<blockquote>
  <p>Vite 将 <code>index.html</code> 视为源码和模块图的一部分。Vite 解析 <code>&#x3C;script type="module" src="..."></code> ，这个标签指向你的 JavaScript 源码。甚至内联引入 JavaScript 的 <code>&#x3C;script type="module"></code> 和引用 CSS 的 <code>&#x3C;link href></code> 也能利用 Vite 特有的功能被解析。另外，<code>index.html</code> 中的 URL 将被自动转换，因此不再需要 <code>%PUBLIC_URL%</code> 占位符了。</p>
</blockquote>
<p>因此我们首先需要修改原有的入口</p>
<p>将 <code>public/index.html</code></p>
<div class="remark-highlight">
  <pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge,chrome=1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>renderer<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webkit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no<span class="token punctuation">"</span></span>
    <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Keywords<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>&#x3C;%= BASE_URL %>favicon.ico<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>&#x3C;%= webpackConfig.name %><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>noscript</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>strong</span><span class="token punctuation">></span></span>本页面需要浏览器支持（启用）JavaScript！！！<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>strong</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token comment">&#x3C;!-- built files will be auto injected --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
</div>
<p>移动到根目录下<code>index.html</code> ，并做修改</p>
<div class="remark-highlight">
  <pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge,chrome=1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>renderer<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webkit<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no<span class="token punctuation">"</span></span>
    <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Keywords<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>icon<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./favicon.ico<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>XXX<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>noscript</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>strong</span><span class="token punctuation">></span></span>本页面需要浏览器支持（启用）JavaScript！！！<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>strong</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>noscript</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token comment">&#x3C;!-- Vite将自动解析下面的js文件 --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>module<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/src/main.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
</div>
<h4 id="环境变量不同">环境变量不同</h4>
<p>Vue CLI 的环境变量和 Vite 的环境变量加载都是通过 <a href="https://github.com/motdotla/dotenv">dotenv</a> 来实现的，因此在文件命名约定上是一致的。但具有以下两点不同：</p>
<ul>
  <li>
    <p>暴露方式</p>
    <ul>
      <li>
        <p>Vue CLI 中约定只有 <code>NODE_ENV</code>、<code>BASE_URL</code> 和以<code>VUE_APP_</code> 开头的变量被暴露出来。</p>
      </li>
      <li>
        <p>Vite 中则约定可以访问 <code>MODE</code> （应用运行的模式 development|production） 、<code>BASE_URL</code> 、<code>PROD</code> （是否运行在生产环境）、<code>DEV</code> （是否运行在开发环境）以及以 <code>VITE_</code> 开头的环境变量。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>访问方式</p>
    <ul>
      <li>
        <p>Vue CLI 通过<code>process.env</code> 来访问</p>
      </li>
      <li>
        <p>Vite 通过 <code>import.meta.env</code> 来访问</p>
      </li>
    </ul>
  </li>
</ul>
<p>由于以上的两点不同，迁移时我们就需要：</p>
<ul>
  <li>将原本以 <code>VUE_APP_</code> 开头的环境变量统一替换为以 <code>VITE_</code> 开头；或者可通过修改配置文件 <code>vite.config.js</code> 的 <a href="https://cn.vitejs.dev/config/index.html#envprefix">envPrefix</a> 进行配置，直接配置为 <code>VUE_APP_</code> 则不需要对原有环境变量名称进行修改。(配置文件的创建下面将会提到)</li>
  <li>将 <code>process.env</code> 统一替换为 <code>import.meta.env</code>。</li>
</ul>
<h4 id="不能忽略自定义导入类型扩展名如vue">不能忽略自定义导入类型扩展名（如<code>.vue</code>）</h4>
<p>在 Vue CLI 中，默认我们可以不写<code>.vue</code>扩展名进行导入</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">"./App"</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>但是在 Vite 中，<strong>不建议</strong>（实测还是可以配置的）忽略自定义扩展名，因为会影响 IDE 和类型支持。因此需要完整书写</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">"./App.vue"</span><span class="token punctuation">;</span>
</code></pre>
</div>
<blockquote>
  <p>非自定义类型的扩展名可以通过配置项 <code>resolve.extensions</code> 来进行配置，默认为 <code>['.mjs', '.js', '.ts', '.jsx', '.tsx', '.json']</code></p>
</blockquote>
<h3 id="出来吧你vite">出来吧你，Vite</h3>
<p>到目前为止，基本的修改以及完成，我们开始引入 Vite。</p>
<p>Vite 的安装比较简单，唯一需要注意的就是对于不同的 Vue 版本，需要用到不同的插件。</p>
<p>安装 Vite</p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> -D
</code></pre>
</div>
<p>安装对应版本的 Vue 插件</p>
<blockquote>
  <p>Vite 为 Vue 提供第一优先级支持：</p>
  <ul>
    <li>Vue 3 单文件组件支持：<a href="https://github.com/vitejs/vite/tree/main/packages/plugin-vue">@vitejs/plugin-vue</a></li>
    <li>Vue 3 JSX 支持：<a href="https://github.com/vitejs/vite/tree/main/packages/plugin-vue-jsx">@vitejs/plugin-vue-jsx</a></li>
    <li>Vue 2 支持：<a href="https://github.com/underfin/vite-plugin-vue2">underfin/vite-plugin-vue2</a></li>
  </ul>
</blockquote>
<p>由于我们使用 Vue2，因此安装 <code>vite-plugin-vue2</code></p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> -D vite-plugin-vue2
</code></pre>
</div>
<p>在根目录创建配置文件 <code>vite.config.js</code></p>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json">import <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> from 'vite'
const <span class="token punctuation">{</span> createVuePlugin <span class="token punctuation">}</span> = require('vite-plugin-vue2')

<span class="token comment">// https://vitejs.dev/config/</span>
export default defineConfig(() => <span class="token punctuation">{</span>
  return <span class="token punctuation">{</span>
    base<span class="token operator">:</span> './'<span class="token punctuation">,</span>
    clearScreen<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>createVuePlugin()<span class="token punctuation">]</span><span class="token punctuation">,</span>
    build<span class="token operator">:</span> <span class="token punctuation">{</span>
      target<span class="token operator">:</span> 'es2015'<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>)
</code></pre>
</div>
<p><strong>完结撒花！！！</strong></p>
<p>如果你的项目没有其他特殊的需求的话，到目前为止，你基本上应该可以跑起来了。不过，我们的项目就没这么幸运了，旅途才刚刚开始。。。</p>
<h2 id="填坑之旅">填坑之旅</h2>
<h3 id="启用-jsx">启用 JSX</h3>
<p>Vite 默认是不启用 JSX 的，如果要开启 JSX 支持还是比较麻烦的，需要：</p>
<ol>
  <li>
    <p>实例化 Vue2 插件的时候传入<code>{jsx: true}</code> 开启 JSX 支持。</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">createVuePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">jsx</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 引入Vue2插件并开启JSX支持</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>在用到的组件上加上 <code>jsx</code> 标识</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>script lang<span class="token operator">=</span><span class="token string">"jsx"</span><span class="token operator">></span>
    <span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token constant">JSX</span> <span class="token maybe-class-name">Render</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>script<span class="token operator">></span>
</code></pre>
    </div>
  </li>
  <li>
    <p>如果是 js 文件，用到了 <code>jsx</code> 语法，则需要将后缀名改完 <code>.jsx</code> 。</p>
  </li>
</ol>
<h3 id="alias">alias</h3>
<p>在原项目中我们在 <code>vue.config.js</code> 中 定义了使用了 Webpack 的 <code>resolve.alias</code> 特性：</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
	<span class="token string-property property">"configureWebpack"</span><span class="token operator">:</span><span class="token punctuation">{</span>
		<span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'@'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@api'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/api'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@components'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/components'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@containers'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/containers'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@services'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/services'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@styles'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/styles'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@utils'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/utils'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token string-property property">'@@containers'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-containers/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@components'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-components/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@services'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-services/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@utils'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/web-lib/packages/web-lib-utils/lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@styles'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/web-lib/packages/web-lib-styles/lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>查看 Vite 的配置文档，发现内置支持了 alias，虽然是通过 <code>@rollup/plugin-alias</code> 来实现的，但是幸运的是配置方式基本是一致的。</p>
<p>因此在<code>vite.config.js</code> 中返回的配置对象中添加对应配置 <code>resolve.alias</code> , 直接复制原有配置对象即可。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">'@'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@api'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/api'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@components'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/components'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@containers'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/containers'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@services'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/services'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@styles'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/styles'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@utils'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/utils'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token string-property property">'@@containers'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-containers/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@components'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-components/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@services'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">'node_modules/web-lib/packages/web-lib-services/lib'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@utils'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/web-lib/packages/web-lib-utils/lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">'@@styles'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/web-lib/packages/web-lib-styles/lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="客户端代码中不能使用-node-内部模块">客户端代码中不能使用 node 内部模块</h3>
<p>Vite 中不对模块兼容做处理，因此一些 Node 的内置模块在客户端代码中将无法找到。如果确实需要用到，则需要替换为对应的浏览器兼容实现。</p>
<p>如 <code>path</code> 模块可以换成对应的浏览器兼容实现 <code>path-browserify</code> 。</p>
<p>原有代码使用 <code>path.join</code> 来拼接路径：</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">path</span> <span class="token keyword module">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">genPath</span><span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>paths</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token spread operator">...</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>在 Vite 中则需要修改为对应浏览器兼容实现 <code>path-browserify</code></p>
<p>首先安装 <code>path-browserify</code></p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> path-browserify
</code></pre>
</div>
<p>然后直接替换引用即可</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">path</span> <span class="token keyword module">from</span> <span class="token string">"path-browserify"</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">genPath</span><span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>paths</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token spread operator">...</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="全局-css-变量">全局 CSS 变量</h3>
<p>在我们原项目中在<code>vue.config.js</code> 中配置引入了 <a href="https://github.com/shakacode/sass-resources-loader">sass-resources-loader</a> 来实现。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 引入全局的sass资源</span>
    <span class="token keyword">const</span> oneOfsMap <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">.</span><span class="token method function property-access">rule</span><span class="token punctuation">(</span><span class="token string">'scss'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">oneOfs</span><span class="token punctuation">.</span><span class="token property-access">store</span>
    oneOfsMap<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      item
        <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'sass-resources-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">loader</span><span class="token punctuation">(</span><span class="token string">'sass-resources-loader'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">options</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">resources</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'./node_modules/web-lib/packages/web-lib-styles/src/variables/index.scss'</span><span class="token punctuation">,</span>
            <span class="token string">'./src/styles/variables.scss'</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>在 Vite 中我们可以通过 <code>css.preprocessorOptions</code> 进行配置。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">preprocessorOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">scss</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">additionalData</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@import './node_modules/web-lib/packages/web-lib-styles/src/variables/index.scss';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>如果你细心的话可能会发现，我们的原代码中引入了两个 CSS 文件。而迁移后的我们只引入了一个 CSS 文件。原因是在 <code>./src/styles/variables.scss</code> 中我们使用了下面的语法导出了 js 变量</p>
<div class="remark-highlight">
  <pre class="language-scss"><code class="language-scss"><span class="token comment">// 导出，供js模块调用</span>
<span class="token selector">:export </span><span class="token punctuation">{</span>
  <span class="token property">bg</span><span class="token punctuation">:</span> <span class="token variable">$bg</span><span class="token punctuation">;</span>
  <span class="token property">text_color</span><span class="token punctuation">:</span> <span class="token variable">$text_color</span><span class="token punctuation">;</span>
  <span class="token property">header_height</span><span class="token punctuation">:</span> <span class="token variable">$header_height</span><span class="token punctuation">;</span>
  <span class="token property">sidebar_width</span><span class="token punctuation">:</span> <span class="token variable">$sidebar_width</span><span class="token punctuation">;</span>
  <span class="token property">header_bg</span><span class="token punctuation">:</span> <span class="token variable">$header_bg</span><span class="token punctuation">;</span>
  <span class="token property">logo_bg</span><span class="token punctuation">:</span> <span class="token variable">$logo_bg</span><span class="token punctuation">;</span>
  <span class="token property">menu_bg</span><span class="token punctuation">:</span> <span class="token variable">$menu_bg</span><span class="token punctuation">;</span>
  <span class="token property">menu_text_color</span><span class="token punctuation">:</span> <span class="token variable">$menu_text_color</span><span class="token punctuation">;</span>
  <span class="token property">menu_active_text_color</span><span class="token punctuation">:</span> <span class="token variable">$menu_active_text_color</span><span class="token punctuation">;</span>
  <span class="token property">menu_hover</span><span class="token punctuation">:</span> <span class="token variable">$menu_hover</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>在 Vite 中会出现，如果配置了 <code>additionalData</code>，将会报错：</p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">Error: This <span class="token function">file</span> is already being loaded.
    ╷
  <span class="token number">2</span> │           @import <span class="token string">'./src/styles/variables.scss'</span><span class="token punctuation">;</span>
    │                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ╵
    src/styles/variables.scss <span class="token number">2</span>:19  root stylesheet
</code></pre>
</div>
<p>可参考以下 ISSUE:</p>
<ul>
  <li><a href="https://github.com/vitejs/vite/issues/3283">https://github.com/vitejs/vite/issues/3283</a></li>
  <li><a href="https://github.com/nuxt/vite/issues/117">https://github.com/nuxt/vite/issues/117</a></li>
</ul>
<p>目前我们的解决方式就是不引入，然后在用到的地方手动进行引入规避这个问题，暂时没有特别好的解决方案。</p>
<h3 id="动态导入-png-等图片资源">动态导入 png 等图片资源</h3>
<p>在 Vue CLI 项目中，我们往往需要通过运行时变量来动态确定一些静态资源来进行导入</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> iconSrc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iconName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>上面的代码使用 webpack 的 url-loader 或 url-loader，将被自动处理</p>
<p>Vite 处理图片资源的动态引入会比较麻烦，有以下几种方式：</p>
<ol>
  <li>
    <p>使用 <code>import.meta.globEager</code> glob 引入</p>
    <blockquote>
      <p>这种方式将会全量的引入匹配的图片</p>
    </blockquote>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> images <span class="token operator">=</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token method function property-access">globEager</span><span class="token punctuation">(</span><span class="token string">"./images/*.png"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将会直接导入所有匹配的图片</span>
<span class="token keyword">const</span> iconSrc <span class="token operator">=</span> iamges<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iconName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>iamges<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iconName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>使用 <code>new URL(url, import.meta.url)</code> 引入</p>
    <blockquote>
      <p>这种方式如果图片不存在在代码层面无法判断</p>
    </blockquote>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> iconSrc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iconName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将返回一个URL实例</span>
</code></pre>
    </div>
  </li>
</ol>
<h3 id="svg-雪碧图">svg 雪碧图</h3>
<p>在原项目中我们使用了 webpack 的 <a href="https://github.com/JetBrains/svg-sprite-loader">svg-sprite-loader</a> 插件来实现 svg 雪碧图。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token function">chainWebpack</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// set svg-sprite-loader</span>
    config<span class="token punctuation">.</span><span class="token property-access">module</span>
      <span class="token punctuation">.</span><span class="token method function property-access">rule</span><span class="token punctuation">(</span><span class="token string">'svg'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token property-access">exclude</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/icons'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span><span class="token property-access">module</span>
      <span class="token punctuation">.</span><span class="token method function property-access">rule</span><span class="token punctuation">(</span><span class="token string">'icons'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">test</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>svg<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token property-access">include</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/icons'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'svg-sprite-loader'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">loader</span><span class="token punctuation">(</span><span class="token string">'svg-sprite-loader'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">options</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">symbolId</span><span class="token operator">:</span> <span class="token string">'icon-[name]'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>感谢社区，在 Vite 中我们可以使用插件**<a href="https://github.com/anncwb/vite-plugin-svg-icons"> vite-plugin-svg-icons </a>** 来进行替换以实现相同的功能。使用方式基本一样，具体使用可以查看相应文档。</p>
<blockquote>
  <p>注意: svg-sprite-loader 需要手动引入 svg 文件，而 vite-plugin-svg-icons 会自动引入。</p>
</blockquote>
<p>在 Vite 配置的 <code>plugins</code> 选项中引入插件</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">viteSvgIcons</span> <span class="token keyword module">from</span> <span class="token string">'vite-plugin-svg-icons'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mode <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
 <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
   <span class="token function">viteSvgIcons</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">iconDirs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/icons/svg'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">symbolId</span><span class="token operator">:</span> <span class="token string">'icon-[name]'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>在 <code>main.js</code> 中引入</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token string">"virtual:svg-icons-register"</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="glob-导入">Glob 导入</h3>
<p>在老项目中我们如果使用了 webpack 的 <code>require.context</code> 语法，在 Vite 中会报错。对应的，Vite 提供了<code>import.meta.glob</code> 和 <code>import.meta.globEager</code> 来代替</p>
<p>例如原本的<code>src/store/index.js</code> 中动态引入 modules</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token comment">// 获取模块文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">getModuleFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> require<span class="token punctuation">.</span><span class="token method function property-access">context</span><span class="token punctuation">(</span><span class="token string">"./modules"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>js<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取模块对象表</span>
<span class="token keyword">const</span> <span class="token function-variable function">getModules</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storeFiles <span class="token operator">=</span> <span class="token function">getModuleFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> modules <span class="token operator">=</span> storeFiles<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">modules<span class="token punctuation">,</span> modulePath</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// set './app.js' => 'app'</span>
    <span class="token keyword">const</span> moduleName <span class="token operator">=</span> modulePath<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token anchor function">^</span><span class="token special-escape escape">\.</span><span class="token escape">\/</span><span class="token group punctuation">(</span><span class="token char-set class-name">.</span><span class="token quantifier number">*</span><span class="token group punctuation">)</span><span class="token special-escape escape">\.</span><span class="token char-set class-name">\w</span><span class="token quantifier number">+</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">"$1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">storeFiles</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    modules<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> modules<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> modules<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">getModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>在 Vite 中改为</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token method function property-access">globEager</span><span class="token punctuation">(</span><span class="token string">"./modules/*.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  pre<span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token group punctuation">(</span><span class="token special-escape escape">\.</span><span class="token escape">\/</span>modules<span class="token escape">\/</span><span class="token alternation keyword">|</span><span class="token special-escape escape">\.</span>js<span class="token group punctuation">)</span></span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> files<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> pre<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="热更新">热更新</h3>
<p>在原本的<code>src/store/index.js</code> 中我们通过以下方式开启了 store 的热更新</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token comment">// 启用模块热更新</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> modulePaths <span class="token operator">=</span> <span class="token function">getModuleFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"./getters"</span><span class="token punctuation">,</span> <span class="token spread operator">...</span><span class="token punctuation">[</span>modulePaths<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取更新后的模块</span>
    <span class="token keyword">const</span> getters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./getters"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">getModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加载新模块</span>
    store<span class="token punctuation">.</span><span class="token method function property-access">hotUpdate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      getters<span class="token punctuation">,</span>
      modules<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>在 Vite 中直接移除即可，不需要额外配置。</p>
<h3 id="在-vite-配置文件中使用环境变量">在 Vite 配置文件中使用环境变量</h3>
<p>如果想在 Vite 配置中使用环境变量，是不能使用 <code>import.meta.env</code> 来获取的，因为 Vite 是先解析配置文件再解析环境变量的。因此只能通过 <a href="https://github.com/motdotla/dotenv">dotenv</a> 来手动解析访问。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mode <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 访问通用环境变量</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PORT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"dotenv"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./.env</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">parsed</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 访问基于运行环境的环境变量</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token constant">VITE_APP_URI_BUSINESS_SERVICE_BASE</span><span class="token punctuation">,</span>
    <span class="token constant">VITE_APP_URI_FILE_SERVICE_BASE</span><span class="token punctuation">,</span>
    <span class="token constant">VITE_APP_USER_SOCTET_BASE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"dotenv"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">parsed</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token constant">PORT</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h2 id="小甜品来点工程化优化">小甜品，来点工程化优化</h2>
<h3 id="huskylint-staged-实现提交-lint">husky+lint-staged 实现提交 lint</h3>
<p>husky 可以让我们定义各种 git-hooks，以实现在 git 生命周期中注入各种钩子来定义我们的工作流，比如做代码校验或者邮件通知等。lint-staged 则让我们可以只对待提交的代码进行处理。结合两者便能实现在期望的 git 生命周期中触发对新提交代码进行一系列操作。最常见的便是在 git 的 commit 之前（<code>pre-commit</code>），对代码进行校验和格式化。</p>
<h4 id="安装及使用">安装及使用</h4>
<ol>
  <li>
    <p>安装 <code>husky</code></p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> -D husky
</code></pre>
    </div>
  </li>
  <li>
    <p>开启 Git hooks</p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> husky <span class="token function">install</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>添加安装项目依赖后自动开启 Git hooks</p>
    <p><code>package.json</code></p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash"><span class="token punctuation">{</span>
  <span class="token string">"scripts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"prepare"</span><span class="token builtin class-name">:</span> <span class="token string">"husky install"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>安装 lint-staged</p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> -D lint-staged
</code></pre>
    </div>
  </li>
  <li>
    <p>配置 lint-staged</p>
    <p><code>package.json</code></p>
    <div class="remark-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"lint-staged"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"**/*.{vue,js}"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"prettier --write"</span><span class="token punctuation">,</span> <span class="token string">"eslint --fix"</span><span class="token punctuation">,</span> <span class="token string">"git add"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"**/*.{html,vue,css,scss}"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"prettier --write"</span><span class="token punctuation">,</span>
      <span class="token string">"stylelint --allow-empty-input --fix"</span><span class="token punctuation">,</span>
      <span class="token string">"git add"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"**/*.{md,json}"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"prettier --write"</span><span class="token punctuation">,</span> <span class="token string">"git add"</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>配置 hook 在提交时触发 lint-staged</p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash">$ npx husky <span class="token function">add</span> .husky/pre-commit <span class="token string">"npx lint-staged"</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>将 hook 添加到 git 中</p>
    <div class="remark-highlight">
      <pre class="language-bash"><code class="language-bash">$ <span class="token function">git</span> <span class="token function">add</span> .husky/pre-commit
</code></pre>
    </div>
  </li>
</ol>
<h4 id="git-支持的钩子及简单介绍">git 支持的钩子及简单介绍</h4>
<table>
  <thead>
    <tr>
      <th>钩子类型</th>
      <th>钩子名称</th>
      <th>触发时机</th>
      <th>钩子参数</th>
      <th>可中止</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>提交工作流钩子</td>
      <td>pre-commit</td>
      <td>键入提交信息前，即生成本次 commit 对象前。是代码检查、测试运行的好时机。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>prepare-commit-msg</td>
      <td>启动提交信息编辑器之前，默认信息被创建之后运行。可以在这里修改默认提交信息。</td>
      <td>filepath commitType SHA-1</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>commit-msg</td>
      <td>输入提交信息后，执行提交前发生。可以在这里检查提交信息是否规范，也可以修改提交信息。</td>
      <td>filepath</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>post-commit</td>
      <td>整个提交完成后。一般用于发生通知，例如邮件通知提交等（但是建议在服务器端 post-receive 钩子中做）。</td>
      <td>\</td>
      <td>否</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>applypatch-msg</td>
      <td>生成补丁提交信息后，应用补丁前。可用来检查补丁提交信息是否规范。</td>
      <td>mergeFilename</td>
      <td>是</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>pre-applypatch</td>
      <td>运行于应用补丁后，产生提交对象之前。因此和 pre-commit 一样是代码检查、测试运行的好时机。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>post-applypatch</td>
      <td>整个提交完成后。同 post-commit 一样是通知的好时机。</td>
      <td>\</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>pre-rebase</td>
      <td>运行于变基前。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-rewrite</td>
      <td>被会替换提交记录的命令所触发。如<code>git commit --amend</code></td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-checkout</td>
      <td>在 git checkout 成功运行后。</td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-merge</td>
      <td>在 git merge 成功运行后。</td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>pre-push</td>
      <td>更新了远程引用但是未推送本地提交前。</td>
      <td>originBranchName HEAD</td>
      <td>是</td>
    </tr>
  </tbody>
</table>
<h2 id="完整地图">完整地图</h2>
<p>下面是迁移完成的目录结构以及完整的 <code>vite.config.js</code> 文件</p>
<div class="remark-highlight">
  <pre class="language-unknown"><code class="language-unknown">├── .browserslistrc
├── .editorconfig
├── .env
├── .env.development
├── .env.production
├── .eslintignore
├── .eslintrc.js
├── .git/
├── .gitignore
├── .husky/
├── .npmrc
├── .nvmrc
├── .prettierignore
├── .prettierrc.js
├── .stylelintignore
├── .stylelintrc.js
├── README.md
├── _templates/
├── dist/
├── dist.tar.gz
├── doc/
├── index.html
├── jsconfig.json
├── package.json
├── public/
├── src/
├── tests/
├── vite.config.js
└── yarn.lock</code></pre>
</div>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">path</span> <span class="token keyword module">from</span> <span class="token string">"path"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vite"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">viteSvgIcons</span> <span class="token keyword module">from</span> <span class="token string">"vite-plugin-svg-icons"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createVuePlugin <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"vite-plugin-vue2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// https://vitejs.dev/config/</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> mode <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">PORT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"dotenv"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./.env</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">parsed</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token constant">VITE_URI_BUSINESS_SERVICE_BASE</span><span class="token punctuation">,</span>
    <span class="token constant">VITE_URI_FILE_SERVICE_BASE</span><span class="token punctuation">,</span>
    <span class="token constant">VITE_USER_SOCTET_BASE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"dotenv"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">parsed</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token string">"./"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">clearScreen</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">createVuePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">jsx</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">viteSvgIcons</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">iconDirs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/icons/svg"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">symbolId</span><span class="token operator">:</span> <span class="token string">"icon-[name]"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".mjs"</span><span class="token punctuation">,</span> <span class="token string">".js"</span><span class="token punctuation">,</span> <span class="token string">".ts"</span><span class="token punctuation">,</span> <span class="token string">".jsx"</span><span class="token punctuation">,</span> <span class="token string">".tsx"</span><span class="token punctuation">,</span> <span class="token string">".json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"@"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@api"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/api"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@components"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/components"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@containers"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/containers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@services"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/services"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@styles"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/styles"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@utils"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"src/utils"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token string-property property">"@@containers"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">"node_modules/web-lib/packages/web-lib-containers/lib"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@@components"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">"node_modules/web-lib/packages/web-lib-components/lib"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@@services"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token string">"node_modules/web-lib/packages/web-lib-services/lib"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@@utils"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"node_modules/web-lib/packages/web-lib-utils/lib"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string-property property">"@@styles"</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">"node_modules/web-lib/packages/web-lib-styles/lib"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">preprocessorOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">scss</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">additionalData</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@import './node_modules/web-lib/packages/web-lib-styles/src/variables/index.scss';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token constant">PORT</span><span class="token punctuation">,</span>
      <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"/user"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token constant">VITE_URI_BUSINESS_SERVICE_BASE</span><span class="token punctuation">,</span>
          <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"/file"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token constant">VITE_URI_BUSINESS_SERVICE_BASE</span><span class="token punctuation">,</span>
          <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"^/group1"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token constant">VITE_URI_FILE_SERVICE_BASE</span><span class="token punctuation">,</span>
          <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 用户中心长链接</span>
        <span class="token string-property property">"^/wsUser"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token constant">VITE_USER_SOCTET_BASE</span><span class="token punctuation">,</span>
          <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token literal-property property">ws</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token comment">// 实际地址没有这个wsmsg前缀</span>
          <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"^/wsUser"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">// 解决ws代理断开后会导致dev server down掉的问题</span>
          <span class="token function">onProxyReqWs</span><span class="token punctuation">(</span><span class="token parameter">proxyReq<span class="token punctuation">,</span> req<span class="token punctuation">,</span> socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            socket<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
              <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// console.error(options)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">build</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">"es2015"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[TypeScript Learning]]></title>
            <link>https://jiangwenyang.com/posts/TypeScript简明指北</link>
            <guid>https://jiangwenyang.com/posts/TypeScript简明指北</guid>
            <pubDate>Wed, 23 Oct 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[一份简单的TypeScript入门指南]]></description>
            <content:encoded><![CDATA[
<h2 id="tldr">TL;DR</h2>
<p>TypeScript 是 JavaScript 的类型的超集，它可以编译成纯 JavaScript。编译出来的 JavaScript 可以运行在任何浏览器上。可以把 Typescript 简单理解为带类型的 Javascript。</p>
<p><strong>优点：</strong></p>
<ul>
  <li>代码可读性和可维护性</li>
  <li>超好的兼容性，从文件类型、变量类型、编译、第三方库等各个方面都兼容现有 JS</li>
  <li>TypeScript 是开源的</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
  <li>
    <p>需要学习成本，对于没接触过后端语言的前端工程师可能成本更高</p>
  </li>
  <li>
    <p>前期会增加开发成本</p>
  </li>
  <li>
    <p>构建成本</p>
  </li>
  <li>
    <p>现有库的声明文件缺失</p>
  </li>
</ul>
<h2 id="起步">起步</h2>
<h3 id="安装">安装</h3>
<div class="remark-highlight">
  <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -g typescript
<span class="token comment"># yarn global add typescript</span>
</code></pre>
</div>
<h3 id="初始化">初始化</h3>
<p>使用<code>tsc --init</code> 可以在当前目录下快速生成 tsconfig.json 文件</p>
<h3 id="hello-world">hello world</h3>
<p>helloWorld.ts</p>
<div class="remark-highlight">
  <pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> say Hello World</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> tomName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"tom"</span><span class="token punctuation">;</span>

<span class="token function">helloWorld</span><span class="token punctuation">(</span>tomName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="编译">编译</h3>
<p>使用<code>tsc helloWorld.ts</code>将 ts 文件编译为 js 文件，支持 glob 模式匹配。</p>
<p>编译过程中如果遇到类型错误会提示，但是仍然能够编译成功。</p>
<p>编译完成生成 helloWorld.js 文件</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> name <span class="token operator">+</span> <span class="token string">" say Hello World"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> tomName <span class="token operator">=</span> <span class="token string">"tom"</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> tomAge <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token function">helloWorld</span><span class="token punctuation">(</span>tomName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">helloWorld</span><span class="token punctuation">(</span>tomAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h2 id="类型">类型</h2>
<h3 id="基础类型">基础类型</h3>
<p>Javascript 中的基础类型有：</p>
<ul>
  <li>值类型（基本类型）
    <ul>
      <li>字符串（String）</li>
      <li>数字(Number)</li>
      <li>布尔(Boolean)</li>
      <li>空（Null）</li>
      <li>未定义（Undefined）</li>
      <li>Symbol</li>
    </ul>
  </li>
  <li>引用数据类型
    <ul>
      <li>对象(Object)</li>
      <li>数组(Array)</li>
      <li>函数(Function)</li>
    </ul>
  </li>
</ul>
<p>Typescript 支持 Javascript 的所有基础类型，并且新增了 <strong>枚举类型</strong> 供我们使用，后文将单独进行介绍。</p>
<h4 id="基础声明一览">基础声明一览</h4>
<div class="remark-highlight">
  <pre class="language-ts"><code class="language-ts"><span class="token comment">/* 字符串 */</span>
<span class="token comment">// 普通字符串</span>
<span class="token keyword">let</span> firstName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"TypeScript"</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> lastName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"Language"</span><span class="token punctuation">;</span>
<span class="token comment">// 模板字符串</span>
<span class="token keyword">let</span> fullName<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">/* 布尔值 */</span>
<span class="token keyword">let</span> isGood<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">/* 数字 */</span>
<span class="token keyword">let</span> myAge<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">/* 数组 */</span>
<span class="token comment">// 使用元素类型后跟[]的方式定义</span>
<span class="token keyword">let</span> list<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 使用数组泛型的方式定义</span>
<span class="token keyword">let</span> list2<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"bar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/* 元组Tuple */</span>
<span class="token comment">// ”元组类型“是已知道元素数量和类型的数组的语义类型，在Typescript中并没有定义这一种类型。</span>
<span class="token keyword">let</span> list3<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">boolean</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/* 枚举 */</span>
<span class="token keyword">enum</span> Color <span class="token punctuation">{</span>
  Red<span class="token punctuation">,</span>
  Green<span class="token punctuation">,</span>
  Blue<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> c<span class="token operator">:</span> Color <span class="token operator">=</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>

<span class="token comment">/* Any */</span>
<span class="token comment">// Any类型是一种动态类型，即可以为任意类型，适用于在编程阶段无法确定的类型（不要滥用Any类型）。</span>
<span class="token keyword">let</span> notSure<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
notSure <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">;</span>
notSure <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
notSure <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 当不知道数组中元素类型时，可以使用any类型</span>
<span class="token keyword">let</span> list4<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"free"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">/* Void */</span>
<span class="token comment">// Void类型代表没有任何类型，Void类型只能赋予undefined和null，一般用于没有返回值的函数的返回值类型</span>
<span class="token keyword">function</span> <span class="token function">noReturn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"This is a function no return value!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Null 和 Undefined */</span>
<span class="token comment">// null 和 undefined 各自对应 null 和 undefined 类型，这两个类型是所有其他类型的子类型。</span>
<span class="token keyword">let</span> u<span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> n<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">/* Never类型 */</span>
<span class="token comment">// never类型表示的是那些永不存在的值的类型</span>
<span class="token keyword">function</span> <span class="token function">error</span><span class="token punctuation">(</span>message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">never</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 返回never的函数必须存在无法达到的终点</span>
<span class="token keyword">function</span> <span class="token function">infiniteLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">never</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Object类型</span>
<span class="token keyword">const</span> obj<span class="token operator">:</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj3<span class="token operator">:</span> object <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="枚举">枚举</h3>
<p>使用枚举我们可以定义一些带名字的常量 。</p>
<p>枚举的特性：</p>
<ul>
  <li>支持名称和值的相互映射</li>
  <li>自增长特性</li>
</ul>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">enum</span> <span class="token maybe-class-name">Direction</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Up</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Down</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Left</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Right</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token maybe-class-name">Color</span> <span class="token punctuation">{</span>
  <span class="token constant">RED</span><span class="token punctuation">,</span>
  <span class="token constant">GREEN</span><span class="token punctuation">,</span>
  <span class="token constant">BLUE</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">enum</span> <span class="token maybe-class-name">DirectionString</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Up</span> <span class="token operator">=</span> <span class="token string">"UP"</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Down</span> <span class="token operator">=</span> <span class="token string">"DOWN"</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Left</span> <span class="token operator">=</span> <span class="token string">"LEFT"</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Right</span> <span class="token operator">=</span> <span class="token string">"RIGHT"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>将会编译成：</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token maybe-class-name">Direction</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Direction</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token string">"Up"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Up"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token string">"Down"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Down"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token string">"Left"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Left"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token string">"Right"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Right"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token maybe-class-name">Color</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Color</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token string">"RED"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"RED"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token string">"GREEN"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"GREEN"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token maybe-class-name">Color</span><span class="token punctuation">[</span><span class="token string">"BLUE"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"BLUE"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token maybe-class-name">Color</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Color</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token maybe-class-name">DirectionString</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">DirectionString</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">DirectionString</span><span class="token punctuation">[</span><span class="token string">"Up"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"UP"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">DirectionString</span><span class="token punctuation">[</span><span class="token string">"Down"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"DOWN"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">DirectionString</span><span class="token punctuation">[</span><span class="token string">"Left"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"LEFT"</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">DirectionString</span><span class="token punctuation">[</span><span class="token string">"Right"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"RIGHT"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token maybe-class-name">DirectionString</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token maybe-class-name">DirectionString</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>可以看到，并没有”黑魔法“。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token string">"Down"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token maybe-class-name">Direction</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'Down'</span>
</code></pre>
</div>
<h3 id="函数">函数</h3>
<p>Javascript 中的函数有两种类型：命名函数、匿名函数</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token comment">// 命名函数</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 匿名函数</span>
<span class="token keyword">let</span> <span class="token function-variable function">myAdd</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>使用 Typescript 分别创建这两种类型的函数</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token comment">// 命名函数</span>
<span class="token comment">// 完整的函数声明</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 一般我们可以省略返回值声明，TS会自动推断出返回值类型。</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 匿名函数</span>
<span class="token comment">// 只指定函数类型</span>
<span class="token keyword">let</span> <span class="token function-variable function">myAdd</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 完整的函数类型</span>
<span class="token keyword">let</span> <span class="token function-variable function">myAdd</span><span class="token operator">:</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  y<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="接口">接口</h3>
<p>接口用于定义结构和类型。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token comment">// 不使用接口</span>
<span class="token keyword">const</span> <span class="token function">foo</span><span class="token punctuation">(</span>fooObj<span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'foo'</span><span class="token punctuation">,</span>age<span class="token operator">?</span><span class="token operator">:</span>number<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>fooObj<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span> <span class="token comment">// 'foo'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'my'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span>myObj<span class="token punctuation">)</span>

<span class="token comment">// 使用接口</span>
<span class="token keyword">interface</span> <span class="token class-name">Foo</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span>string<span class="token punctuation">;</span>
    age<span class="token operator">?</span><span class="token operator">:</span>number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fooObj</span><span class="token operator">:</span><span class="token maybe-class-name">Foo</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>fooObj<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span> <span class="token comment">// 'foo'</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>一个更复杂的例子</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">FooObj</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  age<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>fooObj<span class="token operator">:</span> <span class="token maybe-class-name">FooObj</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function-variable function">method</span><span class="token operator">:</span> <span class="token punctuation">(</span>bar<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fooObj<span class="token operator">:</span> <span class="token maybe-class-name">FooObj</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>fooObj<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'foo'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">method</span> <span class="token operator">=</span> <span class="token punctuation">(</span>bar<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="泛型">泛型</h3>
<p><code>泛型</code>用来创建可重用的组件，一个组件可以支持多种类型的数据。</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">foo</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>arg<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> stringFoo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">foo</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">"foo1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numberFoo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">foo</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="高级类型">高级类型</h3>
<ul>
  <li>
    <h4 id="交叉类型intersection-types">交叉类型（Intersection Types）</h4>
    <p>交叉类型是将多个类型合并为一个类型。 这让我们可以把现有的多种类型叠加到一起成为一种类型，它包含了所需的所有类型的特性。 相当于对所有类型取合集。</p>
    <div class="remark-highlight">
      <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">interface</span> <span class="token class-name">Type1</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Type2</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function-variable function">method</span><span class="token operator">:</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> type1<span class="token operator">:</span> <span class="token maybe-class-name">Type1</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">"type1"</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> type2<span class="token operator">:</span> <span class="token maybe-class-name">Type2</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">method</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> type1<span class="token punctuation">.</span><span class="token property-access">age</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mixedType<span class="token operator">:</span> <span class="token maybe-class-name">Type1</span> <span class="token operator">&#x26;</span> <span class="token maybe-class-name">Type2</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>type1<span class="token punctuation">,</span> <span class="token spread operator">...</span>type2 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
  <li>
    <h4 id="联合类型union-types">联合类型（Union Types）</h4>
    <p>联合类型表示一个值可以是几种类型之一。 写法是用竖线（ <code>|</code>）分隔每个类型，因此 <code>number | string | boolean</code>表示一个值可以是 <code>number</code>， <code>string</code>，或 <code>boolean</code>。</p>
    <blockquote>
      <p>如果一个值是联合类型，我们只能访问此联合类型的所有类型里共有的成员。</p>
    </blockquote>
  </li>
</ul>
<h2 id="typescript-搭配-react">Typescript 搭配 React</h2>
<p>Typescript 和 React 可以很好的一起工作，一般我们使用 React 离不开 Webpack。因此在这里介绍下如何构建 Typescript+React+Webpack 技术栈。</p>
<h3 id="安装依赖">安装依赖：</h3>
<div class="remark-highlight">
  <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i  react react-dom
<span class="token function">npm</span> i -D webpack-cli webpack @types/react @types/react-dom
</code></pre>
</div>
<p>在 Webpack 中解析 Typescript 需要使用 loader，目前主要有以下几种解决方案：</p>
<ul>
  <li>awesome-typescript-loader （没用过。。。）</li>
  <li>ts-loader (官方)</li>
  <li>babel-loader (babel 7.0 版本之后)</li>
</ul>
<p>很多情况下我们使用了 ts-loader 之后仍然需要使用 babel-loader 转换一些 ts-loader 无法转换的语法特性，因此为什么不直接使用 babel-loader 来转换 ts 文件呢。babel 从 7.0 版本后开始支持编译 Typescript。在这里主要介绍一下使用 babel-loader 编译 Typescript 和 React。</p>
<ul>
  <li>
    <p>安装 babel-core 和 babel-loader</p>
    <div class="remark-highlight">
      <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -D @babel/core babel-loader@latest
</code></pre>
    </div>
  </li>
  <li>
    <p>安装@babel/preset-env 编译 ES 最新的语法</p>
    <div class="remark-highlight">
      <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -D @babel/preset-env
</code></pre>
    </div>
  </li>
  <li>
    <p>安装@babel/preset-react 用于编译 React</p>
    <div class="remark-highlight">
      <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -D @babel/preset-react
</code></pre>
    </div>
  </li>
  <li>
    <p>安装 @babel/preset-typescript 用于编译 Typescript</p>
    <div class="remark-highlight">
      <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -D @babel/preset-typescript
</code></pre>
    </div>
  </li>
  <li>
    <p>安装 @babel/plugin-proposal-class-properties 插件支持类的静态属性语法</p>
    <div class="remark-highlight">
      <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">class</span> <span class="token class-name">Myclass</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    </div>
    <div class="remark-highlight">
      <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> i -D @babel/plugin-proposal-class-properties
</code></pre>
    </div>
  </li>
</ul>
<h3 id="配置-babel">配置 babel</h3>
<p>在根目录下新建并配置<code>.babelrc</code>文件</p>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"@babel/preset-react"</span><span class="token punctuation">,</span>
    <span class="token string">"@babel/preset-typescript"</span><span class="token punctuation">,</span>
    <span class="token string">"@babel/preset-env"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"@babel/proposal-class-properties"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="配置-webpack">配置 Webpack</h3>
<p>新建并配置<code>webpack.config.js</code>文件</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src"</span><span class="token punctuation">,</span> <span class="token string">"index"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"build"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">"bundle.js"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>tsx<span class="token quantifier number">?</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"node_modules"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"babel-loader"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="配置-packagejson-script">配置 package.json script</h3>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"webpack --config webpack.config.js"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="函数式组件">函数式组件</h3>
<p>ButtonFC.tsx</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">React</span></span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">PropTypes</span></span> <span class="token keyword">from</span> <span class="token string">"prop-types"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ButtonProps</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">HTMLAttributes</span></span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HTMLButtonElement</span><span class="token operator">></span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Button</span><span class="token operator">:</span> <span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token constant">FC</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonProps</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token spread operator">...</span>otherProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token keyword">const</span> buttonClassName <span class="token operator">=</span> className<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>buttonClassName<span class="token punctuation">}</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token spread operator">...</span>otherProps<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">Button</span><span class="token punctuation">.</span><span class="token property-access">propTypes</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token maybe-class-name">PropTypes</span><span class="token punctuation">.</span><span class="token property-access">string</span><span class="token punctuation">.</span><span class="token property-access">isRequired</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token maybe-class-name">Button</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="类组件">类组件</h3>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">React</span></span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">PropTypes</span></span> <span class="token keyword">from</span> <span class="token string">"prop-types"</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ButtonCountProps</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">HTMLAttributes</span></span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HTMLButtonElement</span><span class="token operator">></span> <span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">ButtonCountState</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ButtonCount</span> <span class="token keyword">extends</span> <span class="token class-name">React</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Component</span></span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonCountProps</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ButtonCountState</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> propTypes <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token maybe-class-name">PropTypes</span><span class="token punctuation">.</span><span class="token property-access">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click </span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span><span class="token plain-text"> times</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token maybe-class-name">ButtonCount</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="入口文件">入口文件</h3>
<p>App.ts</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">React</span></span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonFC</span></span> <span class="token keyword">from</span> <span class="token string">"./ButtonFC"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonClass</span></span> <span class="token keyword">from</span> <span class="token string">"./ButtonClass"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">App</span><span class="token operator">:</span> <span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access"><span class="token maybe-class-name">FC</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">ButtonFC</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ButtonFC<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text">ButtonFC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span><span class="token class-name">ButtonFC</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">ButtonClass</span></span><span class="token punctuation">></span></span><span class="token plain-text">ButtonClass</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span><span class="token class-name">ButtonClass</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token maybe-class-name">App</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>index.tsx</p>
<div class="remark-highlight">
  <pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">React</span></span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">ReactDOM</span></span> <span class="token keyword">from</span> <span class="token string">"react-dom"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword">from</span> <span class="token string">"./App"</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">App</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="编译打包">编译打包</h3>
<div class="remark-highlight">
  <pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> run start
</code></pre>
</div>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[CSS中的空白符和换行处理]]></title>
            <link>https://jiangwenyang.com/posts/CSS中的空白符和换行处理</link>
            <guid>https://jiangwenyang.com/posts/CSS中的空白符和换行处理</guid>
            <pubDate>Tue, 11 Sep 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[简单介绍CSS中空白符和换行处理，主要介绍white-space、word-break、word-wrap三个属性]]></description>
            <content:encoded><![CDATA[
<h2 id="css-中的空白符和换行处理">CSS 中的空白符和换行处理</h2>
<p>CSS 中主要有三个属性用来处理空白符和换行：<code>white-space</code> <code>word-break</code> <code>word-wrap</code> ，长得有点相似，在中文环境下用到的机会不太多，但是每次用到都傻傻分不清楚，下面整理下这几个属性的区别。</p>
<h3 id="white-space">white-space</h3>
<p><code>white-space</code> 看名字就知道主要是用来处理空白符的，但是也涉及到换行的问题。</p>
<p><code>white-space</code> 的有下列的值，对应其中的空白符和换行符处理情况：</p>
<table>
  <thead>
    <tr>
      <th>属性</th>
      <th>空白符</th>
      <th>换行符</th>
      <th>超出是否自动换行</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>normal ( 默认值 )</td>
      <td>多个连续空格合并为一个</td>
      <td>视为空白符一起处理</td>
      <td>是</td>
    </tr>
    <tr>
      <td>pre</td>
      <td>保留</td>
      <td>保留</td>
      <td>否</td>
    </tr>
    <tr>
      <td>pre-wrap</td>
      <td>保留</td>
      <td>保留</td>
      <td>是</td>
    </tr>
    <tr>
      <td>pre-line</td>
      <td>多个连续空格合并为一个</td>
      <td>保留</td>
      <td>是</td>
    </tr>
    <tr>
      <td>no-wrap</td>
      <td>多个连续空格合并为一个</td>
      <td>视为空白符一起处理</td>
      <td>否</td>
    </tr>
  </tbody>
</table>
<p><code>white-space</code> 主要定义空白符和换行符的处理，以及超出是否换行。而对于超出时如何换行则由下面两位进行定义。</p>
<h3 id="word-break">word-break</h3>
<p><code>word-break</code> 定义了换行时对单词如何进行处理。包括下面三个关键字值：</p>
<table>
  <thead>
    <tr>
      <th>值</th>
      <th>描述</th>
      <th>单词过长是否会自动截断</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>normal （默认值）</td>
      <td>默认换行规则</td>
      <td>否</td>
    </tr>
    <tr>
      <td>break-all</td>
      <td>允许任意非 CJK(Chinese/Japanese/Korean)文本间的单词断行。</td>
      <td>是</td>
    </tr>
    <tr>
      <td>keep-all</td>
      <td>不允许 CJK(Chinese/Japanese/Korean)文本中的单词换行，只能在半角空格或连字符处换行。非 CJK 文本的行为实际上和<code>normal</code>一致。</td>
      <td>否</td>
    </tr>
  </tbody>
</table>
<p><code>break-all</code> 的兼容性比较好，几乎所有浏览器都支持。<code>keep-all</code> 支持率比较查，并且实用性不强。</p>
<h3 id="word-wrap">word-wrap</h3>
<p><code>word-wrap</code> 和 <code>word-break</code> 很相似，但是其实仔细研究下你会发现他们区别挺大。<code>word-wrap</code> 支持下面两个关键字属性：</p>
<table>
  <thead>
    <tr>
      <th>值</th>
      <th>描述</th>
      <th>单词过长是否会自动截断</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>normal （默认值）</td>
      <td>默认的换行规则</td>
      <td>否</td>
    </tr>
    <tr>
      <td>break-word</td>
      <td>表示如果行内没有多余的地方容纳该单词到结尾，则那些正常的不能被被分割的单词会被强制分割换行。</td>
      <td>否</td>
    </tr>
  </tbody>
</table>
<blockquote>
  <p>**MDN 注：**word-wrap 属性原本属于微软的一个私有属性，在 CSS3 现在的文本规范草案中已经被重名为 overflow-wrap 。 word-wrap 现在被当作 overflow-wrap 的 “别名”。 稳定的谷歌 Chrome 和 Opera 浏览器版本支持这种新语法。</p>
</blockquote>
<h3 id="word-breakbreak-all-和-word-wrapbreak-word区别">word-break:break-all; 和 word-wrap:break-word；区别</h3>
<ul>
  <li>
    <p>相同点：两者都控制换行时如何处理超出的单词。</p>
  </li>
  <li>
    <p>不同点：</p>
    <ul>
      <li><code>word-break:break-all;</code> 简单粗暴，直接将单词截断，超出部分在下一行进行显示，即会将单词一分为二。</li>
      <li><code>word-wrap:break-word;</code> 比较温柔，不会将单词截断，会将超出的单词直接移到下一行显示，如果一行无法显示单词，也不会进行截断，而是让它超出。</li>
    </ul>
  </li>
</ul>
<p><code>word-wrap:break-word;</code> 老师在指挥排队：</p>
<blockquote>
  <p>糟糕，这一排站不下了，怎么办？</p>
  <p>你直接去下面一排第一个，后面的人跟着你继续排。</p>
</blockquote>
<p><code>word-break:break-all;</code> 老师在指挥排队：</p>
<blockquote>
  <p>糟糕，这一排站不下了，怎么办？</p>
  <p>把你掰成两半，一半放到这排的最后，一半放到下面一排的开头。（太血腥了！！！）</p>
</blockquote>
<p><a href="https://stackblitz.com/edit/word-wrap-and-word-break?file=index.html">DEMO</a></p>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[前端自动化测试]]></title>
            <link>https://jiangwenyang.com/posts/前端自动化测试</link>
            <guid>https://jiangwenyang.com/posts/前端自动化测试</guid>
            <pubDate>Tue, 19 Jun 2018 10:20:26 GMT</pubDate>
            <description><![CDATA[前端自动化测试概念以及部分基础工具库介绍，带你入门前端测试]]></description>
            <content:encoded><![CDATA[
<h2 id="为什么需要自动化测试">为什么需要自动化测试</h2>
<p>项目经过不断的开发，最终肯定会趋于稳定，在适当的时机下引入自动化测试能及早发现问题，保证产品的质量。</p>
<div class="remark-highlight">
  <pre class="language-unknown"><code class="language-unknown">自动化的收益 = 迭代次数 * 全手动执行成本 - 首次自动化成本 - 维护次数 * 维护成本</code></pre>
</div>
<h2 id="测试">测试</h2>
<p>测试作为完整的开发流程中最后的一环，是保证产品质量重要的一环。而前端测试一般在产品开发流程中属于偏后的环节，在整个开发架构中属于较高层次，前端测试更加偏向于 GUI 的特性，因此前端的测试难度很大。</p>
<h3 id="测试方法">测试方法</h3>
<h4 id="黑盒测试">黑盒测试</h4>
<p>黑盒测试一般也被称为功能测试，黑盒测试要求测试人员将程序看作一个整体，不考虑其内部结构和特性，只是按照期望验证程序是否能正常工作。黑盒测试更接近用户使用的真实场景，因为对于用户来说，程序的内部是不可见的。</p>
<p>以下是黑盒测试中常用的测试方法：</p>
<ul>
  <li>
    <p>等价类划分</p>
    <p>等价类划分主要是在已有输入规则的情况下，确定合法输入与非法输入区间来设计测试用例</p>
    <p>如：如网站登录密码必须由 6 位数字构成</p>
    <p>有效等价类：6 位数字</p>
    <p>无效等价类：位数>6，位数&#x3C;6，全角数字，字母、特殊字符等......</p>
  </li>
  <li>
    <p>边界值分析</p>
    <p>顾名思义，主要是根据输入输出范围的边界值进行测试用例的设计。原因是<strong>大量的错误往往发生在输入或输出范围的边界上</strong>（程序员往往在容易在这些地方犯错），边界值分析一般结合等价类划分进行使用，等价类划分区间边界一般就是边界值。</p>
    <p>如：如网站登录密码长度必须为 6-12 位</p>
    <p>有效等价类：位数[6-12]</p>
    <p>无效等价类：位数&#x3C;6 位数>12</p>
    <p>边界值：6 12</p>
  </li>
  <li>
    <p>错误推测、异常分析等</p>
    <p>黑盒测试还包含一些其他的测试方式，由于测试往往是不可穷举性的，因此如何如何设计测试用例保证测试覆盖尽可能多的场景，不仅仅是依靠这些总结出来的<strong>方法</strong>，也考验测试人员自身的<strong>天赋</strong>。</p>
  </li>
</ul>
<h4 id="白盒测试">白盒测试</h4>
<p>白盒测试是基于代码本身的测试，一般指对代码逻辑结构的测试。白盒测试是在了解代码结构的前提下进行的测试，目的是遍历尽可能多的可执行路径，得出测试数据。白盒测试方法比较多，主要是<strong>逻辑覆盖</strong>，即检查代码的每一行、每一次判断结果。</p>
<p>逻辑覆盖方式从发现错误能力上排序主要有以下几种：</p>
<ol>
  <li>语句覆盖 （让程序执行到每一行语句）</li>
  <li>判定覆盖 （让每一个判断语句满足真假）</li>
  <li>条件覆盖 （让每一个判断语句里面的每一个条件都取到真假值）</li>
  <li>判定/条件覆盖 （同时满足 2 和 3）</li>
  <li>条件组合覆盖 （判断语句中条件的每种组合至少出现一次）</li>
  <li>路径覆盖 （覆盖程序每一条执行路径）</li>
</ol>
<h3 id="测试分类">测试分类</h3>
<p>按照软件工程自底而上的概念，前端测试一般分为单元测试（Unit Testing ）、集成测试（Integration Testing）和端到端测试（E2E Testing）。从下面的图可以看出，从底向上测试的复杂度将不断提高，另一方面测试的收益反而不断降低的。</p>
<p>
  <img src="http://ow67vzejn.bkt.clouddn.com/18-6-8/26578640.jpg" alt="前端测试模型">
</p>
<h4 id="单元测试unit-testing">单元测试（Unit Testing）</h4>
<p>单元测试是指对程序中<strong>最小</strong>可测试单元进行的测试，一般而言是指对函数进行的测试。单元测试混合了编程和测试，由于是对代码内部逻辑进行测试，因此更多的使用白盒的测试方式。单元测试能强迫开发者写出更可测试的代码，一般而言这样的代码可读性也会高很多，同时良好的单元测试可以作为被测代码的文档使用。</p>
<blockquote>
  <p>函数可测性：可测试性高的函数一般而言是纯函数，即输入输出可预测的函数。即在函数内部不修改传入参数，不执行 API 请求或者 IO 请求，不调用其他非纯函数如 Math.random()等</p>
</blockquote>
<p>单元测试最大的特点是测试对象的细颗粒度性，即被测对象独立性高、复杂度低。</p>
<h5 id="前端单元测试">前端单元测试</h5>
<p>前端单元测试和后端单元测试最大的区别在于，前端单元测试无法避免的会存在兼容性问题，如调用浏览器兼容性 API，以及对 BOM（浏览器对象模型）API 的调用，因此前端单元测试需要运行在（伪）浏览器环境下。</p>
<p>就测试运行环境分类，主要有以下几种测试方案：</p>
<ul>
  <li>基于<a href="https://github.com/jsdom/jsdom">JSDOM</a>
    <ul>
      <li><strong>优点</strong>：快，执行速度最快，因为不需要浏览器启动</li>
      <li><strong>缺点</strong>：无法测试如 seesion 或 cookie 等相关操作，并且由于不是真实浏览器环境因此无法保证一些如 Dom 相关和 BOM 相关的操作的正确性，并且 JSDOM 未实现 localStorage，如果需要进行覆盖，只能使用第三方库如<a href="https://github.com/lmaccherone/node-localstorage">node-localStorage</a> （这个库本身对与执行环境的判断有一些问题）进行模拟。</li>
    </ul>
  </li>
</ul>
<ul>
  <li>基于<a href="https://github.com/ariya/phantomjs">PhantomJs</a>等无头浏览器
    <ul>
      <li><strong>优点</strong>: 相对较快，并且具有真实的 DOM 环境</li>
      <li><strong>缺点</strong>: 同样不在真实浏览器中运行，难以调试，并且项目 issue 非常多，puppeteer 发布后作者宣布不再维护</li>
    </ul>
  </li>
  <li>使用 Karma 或 puppeteer 等工具，调用真实的浏览器环境进行测试
    <ul>
      <li><strong>优点</strong>：配置简单，能在真实的浏览器中运行测试，并且 karma 能将测试代码在多个浏览器中运行,同时方便调试</li>
      <li><strong>缺点</strong>: 唯一的缺点就是相对前两者运行稍慢，但是在单元测试可接受范围内</li>
    </ul>
  </li>
</ul>
<h6 id="前端单元测试工具">前端单元测试工具</h6>
<p>前端在近几年如雨后春笋一般涌现出非常多的测试框架和相关工具。</p>
<ul>
  <li>测试平台
    <ul>
      <li><a href="https://karma-runner.github.io/2.0/index.html">karma</a> -- Google Angular 团队开发的测试运行平台，配置简单灵活，能够很方便将测试在多个真实浏览器中运行。</li>
    </ul>
  </li>
</ul>
<ul>
  <li>测试框架
    <ul>
      <li><a href="https://mochajs.org/">mocha</a> -- Tj 大神开发的很优秀的测试框架，有完善的生态系统，简单的测试组织方式，不对断言库和工具做任何限制，非常灵活。</li>
      <li><a href="https://jasmine.github.io/">jasmine</a> -- 和 Mocha 语法非常相似，最大的差别是提供了自建的断言和 Spy 和 Stub</li>
      <li><a href="https://facebook.github.io/jest/">jest</a> -- facebook 出品的大而全的测试框架，React 官方推荐的单元测试框架，配置简单运行速度快。（备注：无法和 Karma 进行集成）</li>
      <li><a href="https://github.com/avajs/ava">AVA</a> -- 和上面的测试框架最大的区别在于多线程，运行速度更快。</li>
      <li>其他 -- 还有一些其他的前端测试框架，但是相似度比较高，无非是对断言和测试桩等工具的集成度不同，如果考虑稳定以及成熟度建议选择 Mocha，对测试运行速度有非常高的要求可以考虑 jest 和 AVA</li>
    </ul>
  </li>
  <li>测试辅助工具
    <ul>
      <li>断言库 -- <a href="https://github.com/chaijs/chai">Chai</a> 如果单元测试不跑在真实的浏览器环境中，可以简单使用 node 的 assert，但是建议使用 Chai 作为断言库（提供了 TDD 和 BDD 风格多种断言方式，并且生态系统繁荣）。</li>
      <li>测试桩（又称为测试替身） -- <a href="http://sinonjs.org/">Sinon</a>、<a href="https://github.com/testdouble/testdouble.js/">testDouble</a>等工具提供了如测试桩、拦截模拟请求、”时间旅行“等功能，主要用于解决"函数不纯"（比如测试回调是否被正确调用，XHR 是否正确发起请求，时间延迟后函数行为是否正确）的测试问题。</li>
    </ul>
  </li>
  <li>测试覆盖率工具
    <ul>
      <li><a href="https://github.com/gotwarlost/istanbul">istanbul</a> istanbul 的基础实现，提供了命令行等工具，但是无法解决代码编译打点的问题</li>
      <li><a href="https://github.com/webpack-contrib/istanbul-instrumenter-loader">istanbul-instrumenter-loader</a> istanbul 的 Webpack 插件，能解决代码编译打点和测试报告输出的问题</li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>其他参考</p>
  <ul>
    <li><a href="https://github.com/domenic/chai-as-promised">chai-as-promise</a> 扩展 Chai 在 Promise 上的断言功能</li>
    <li><a href="https://github.com/domenic/sinon-chai">sinon-chai</a> 扩展 Chai 搭配 Sinon 时的断言功能</li>
    <li><a href="https://github.com/chaijs/chai-jquery">chai-jquery</a> 扩展 Chai 在 UI 测试中的断言</li>
    <li><a href="https://istanbul.js.org/">istanbul 官网</a> 介绍了 istanbul 如何与多中测试框架集成以及对于 Typescript 等语言的支持</li>
    <li><a href="http://www.ruanyifeng.com/blog/2015/06/istanbul.html">阮一峰-代码覆盖率工具 Istanbul 入门教程</a> 介绍了代码覆盖率相关的概念以及 Istanbul 搭配 Mocha 的简单使用</li>
  </ul>
</blockquote>
<h6 id="常见单元测试栗子">常见单元测试栗子</h6>
<p>在框架选型的时候考虑到以下条件或问题：</p>
<ol>
  <li>测试需要在真实浏览器中运行</li>
  <li>测试执行需要足够迅速</li>
  <li>被测代码为 Typescript，因此使用需要解决编译和打点的问题</li>
  <li>方便持续集成</li>
</ol>
<p>最后选择使用 Karma+Webpack+Mocha+Chai+Sion+istanbul-instrumenter-loader 的解决方案。</p>
<p>项目结构:</p>
<p>
  <img src="http://ow67vzejn.bkt.clouddn.com/18-6-15/99549910.jpg" alt="">
</p>
<p>karma 可以很方便的与 Webpack 进行集成，只需要指定需要预编译的文件和使用的编译工具即可。</p>
<p><em>karma.conf.js 配置 Webpack 编译</em></p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token keyword module">export</span><span class="token operator">=</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">frameworks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'mocha'</span><span class="token punctuation">,</span> <span class="token string">'chai'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'tests/setup.js'</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">'tests/setup.js'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'webpack'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">webpack</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span><span class="token string">'.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'ts-loader'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token literal-property property">transpileOnly</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token group punctuation">(</span>node_modules<span class="token alternation keyword">|</span>libs<span class="token alternation keyword">|</span><span class="token special-escape escape">\.</span>test<span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span><span class="token group punctuation">)</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'istanbul-instrumenter-loader'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token literal-property property">esModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token literal-property property">produceSourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'inline-source-map'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// karma-server support ts/tsx mime</span>
        <span class="token literal-property property">mime</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string-property property">'text/x-typescript'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ts'</span><span class="token punctuation">,</span> <span class="token string">'tsx'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>通过上面的配置中需要注意几个地方：</p>
<ul>
  <li>
    <p>setup.js</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 导入所有测试用例</span>
<span class="token keyword">const</span> testsContext <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token method function property-access">context</span><span class="token punctuation">(</span><span class="token string">"../src"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>test<span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testsContext<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>testsContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
    <p>使用 webpack 提供的<a href="https://webpack.docschina.org/guides/dependency-management/">require.context()</a>将所有测试文件统一导入，然后 karma 将 setup.js 作为入口调用 webpack 进行编译，然后测试执行。</p>
  </li>
  <li>
    <p>mime 配置对于 ts/tsx 的支持</p>
  </li>
  <li>
    <p>istanbul-instrumenter-loader loader 调用顺序必须在 ts 或 babel 等编译工具编译之前否则将不准确，排除测试文件本身和依赖库覆盖率计算</p>
    <ul>
      <li>使用 enforce: 'post',确保 loader 调用顺序</li>
      <li>使用 exclude 排除第三方库和测试文件本身覆盖率计算</li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>其他配置请参考 karma 和 webpack，以及相关插件的文档</p>
</blockquote>
<ul>
  <li>
    <p>纯函数测试</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token doc-comment comment">/**
 * 验证邮箱
 * <span class="token keyword">@params</span> input 输入值
 * <span class="token keyword">@return</span> 返回是否是邮箱
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">mail</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">input</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token anchor function">^</span><span class="token char-class"><span class="token char-class-punctuation punctuation">[</span><span class="token char-set class-name">\w</span><span class="token escape">\-</span><span class="token char-class-punctuation punctuation">]</span></span><span class="token quantifier number">+</span><span class="token group punctuation">(</span><span class="token special-escape escape">\.</span><span class="token char-class"><span class="token char-class-punctuation punctuation">[</span><span class="token char-set class-name">\w</span><span class="token escape">\-</span><span class="token char-class-punctuation punctuation">]</span></span><span class="token quantifier number">+</span><span class="token group punctuation">)</span><span class="token quantifier number">*</span>@<span class="token char-class"><span class="token char-class-punctuation punctuation">[</span><span class="token char-set class-name">\w</span><span class="token escape">\-</span><span class="token char-class-punctuation punctuation">]</span></span><span class="token quantifier number">+</span><span class="token group punctuation">(</span><span class="token special-escape escape">\.</span><span class="token char-class"><span class="token char-class-punctuation punctuation">[</span><span class="token char-set class-name">\w</span><span class="token escape">\-</span><span class="token char-class-punctuation punctuation">]</span></span><span class="token quantifier number">+</span><span class="token group punctuation">)</span><span class="token quantifier number">+</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token method function property-access">test</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"验证邮箱#mail"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"传入邮箱字符串，返回true"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"abc@123.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"abc@123.com.cn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"a-b-c@123.com.cn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"a_b_c@123.com.cn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"a_b_c@123-4-5-6.com.cn"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"传入非邮箱字符串，返回true"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"abc@"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"@123.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"abc@123"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mail</span><span class="token punctuation">(</span><span class="token string">"123.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Promise 或其他异步操作的测试</p>
    <p>Mocha 支持异步测试，主要有下面三种方式：</p>
    <ul>
      <li>
        <p>使用 async await</p>
        <div class="remark-highlight">
          <pre class="language-unknown"><code class="language-unknown">it(async ()=&#x26;gt;{
    await asynchronous()
    // 一些断言
})</code></pre>
        </div>
      </li>
      <li>
        <p>使用回调函数</p>
        <div class="remark-highlight">
          <pre class="language-unknown"><code class="language-unknown">it(done=&#x26;gt;{
    Promise.resolve().then(()=&#x26;gt;{
        // 断言
        done() // 测试结束后调用回调标识测试结束
    })
})</code></pre>
        </div>
      </li>
      <li>
        <p>返回一个 Promise</p>
        <div class="remark-highlight">
          <pre class="language-unknown"><code class="language-unknown">it(()=&#x26;gt;{
  // 直接返回一个Promise，Mocha会自动等待Promise resolve
    return Promise.resolve().then(()=&#x26;gt;{
        // 断言
    })
})</code></pre>
        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>含 HTTP 请求的测试</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">http</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用XHR发送ajax请求</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"method为GET"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xhr <span class="token operator">=</span> fake<span class="token punctuation">.</span><span class="token method function property-access">useFakeXMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  xhr<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onCreate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">xhr</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    requests<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>xhr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  requests<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">respond</span><span class="token punctuation">(</span>
    <span class="token number">200</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'[{ "id": 12, "comment": "Hey there" }]'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/uri"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    xhr<span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>request<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
    <p>或者封装一下 fakeXMLHttpRequest</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token doc-comment comment">/**
 * 使用fakeXMLHttpRequest
 * <span class="token keyword">@param</span> <span class="token parameter">callback</span> 回调函数，接受请求对象作为参数
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useFakeXHR</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fakeXHR <span class="token operator">=</span> <span class="token function">useFakeXMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token literal-property property">requests</span><span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span>any<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// requests会将引用传递给callback，因此使用const，避免指针被改写。</span>

  fakeXHR<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onCreate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> requests<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">callback</span><span class="token punctuation">(</span>requests<span class="token punctuation">,</span> fakeXHR<span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span>fakeXHR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"method为GET"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">useFakeXHR</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> restore</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/uri"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>request<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
    <p>useFakeXHR 封装了对 Sinon 的 useFakeXMLHttpRequest，实现对 XHR 请求的 fake</p>
    <blockquote>
      <p><a href="http://sinonjs.org/releases/v6.0.0/fake-xhr-and-server/">Fake XHR and server - Sinon.JS</a> 官方文档参考</p>
      <p>Fake XHR 和 Fake server 的区别：后者是对前者的更高层次的封装，并且 Fake server 的颗粒度更大</p>
    </blockquote>
  </li>
  <li>
    <p>时间相关的测试</p>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token comment">// 延迟delay毫秒后调用callback</span>
<span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token parameter">delay<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"timer"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> clock <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> spy <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token method function property-access">spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 测试替身</span>
  <span class="token function">timer</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> spy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  clock<span class="token punctuation">.</span><span class="token method function property-access">tick</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "时间旅行，去到1000ms后"</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">.</span><span class="token property-access">called</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
  clock<span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 恢复时间，否则将影响到其他测试</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>浏览器相关 API 调用的测试</p>
    <ul>
      <li>session 的栗子</li>
    </ul>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token doc-comment comment">/**
 * WebStorage封装
 * <span class="token keyword">@param</span> <span class="token parameter">storage</span> 存储对象，支持localStorage和sessionStorage
 * <span class="token keyword">@return</span> 返回封装的存储接口
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Storage</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">storage</span><span class="token operator">:</span> <span class="token maybe-class-name">Storage</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * 获取session
   * <span class="token keyword">@param</span> <span class="token parameter">key</span>
   * <span class="token keyword">@return</span> 返回JSON解析后的值
   */</span>
  <span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">key</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> item <span class="token operator">=</span> storage<span class="token punctuation">.</span><span class="token method function property-access">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function"><span class="token maybe-class-name">Storage</span></span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"session"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token string">"清空sessionStorage"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">.</span><span class="token method function property-access">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"获取session#get"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"获取简单类型值"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"获取引用类型值"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">sessionStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"object"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">deep</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"获取不存在的session"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token keyword null nil">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
    <ul>
      <li>设置 title 的栗子</li>
    </ul>
    <div class="remark-highlight">
      <pre class="language-js"><code class="language-js"><span class="token doc-comment comment">/**
 * 设置tab页title
 * <span class="token keyword">@param</span> <span class="token parameter">title</span>
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token parameter">title</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当页面中嵌入了flash，并且页面的地址中含有“片段标识”（即网址#之后的文字）IE标签页标题被自动修改为网址片段标识</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">userAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">app</span> <span class="token operator">===</span> <span class="token maybe-class-name">Browser</span><span class="token punctuation">.</span><span class="token constant">MSIE</span> <span class="token operator">||</span> <span class="token function">userAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">app</span> <span class="token operator">===</span> <span class="token maybe-class-name">Browser</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Edge</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> title<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> title<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"设置tab页title#setTitle"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 这个测试不是个好的测试，测试代码更改了页面DOM结构</span>
  <span class="token keyword">const</span> originalTitle <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span> <span class="token comment">// 保存原始title，测试结束后恢复</span>
  <span class="token keyword">const</span> clock <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"test title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clock<span class="token punctuation">.</span><span class="token method function property-access">tick</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">"test title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTitle</span><span class="token punctuation">(</span>originalTitle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 恢复原本的title</span>
  clock<span class="token punctuation">.</span><span class="token method function property-access">tick</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  clock<span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
</ul>
<h6 id="react-组件单元测试">React 组件单元测试</h6>
<p>React 组件的测试本质上和其他单元测试区别不大，但是 React 组件单元测试由于涉及到“浏览器渲染”问题，在复杂度上高很多，并且 React 组件除基础 UI 组件（如 Button、Link）等底层组件外，其实很难保持其“规模”在“最小测试单元”这一范围内，虽然可以通过“浅渲染”（不渲染子组件）降低组件的复杂度。从单元测试的范畴和意义出发来看，其实大多数 UI 组件的测试很难归入单元测试中。由于“大家貌似都觉得理所应当”，本文档依然将 UI 组件测试作为单元测试介绍。</p>
<blockquote>
  <p>没有打开盒子时，我们无法决定猫是否还活着。</p>
</blockquote>
<p>React 并非一个黑盒，因此想要测试 React，必须先了解 React 是如何渲染的。当然，咱们不需要去了解 React 的源码，知道个大概就好了。</p>
<p>简单来讲，一个 React 组件渲染到页面中需要下面几步。</p>
<ol>
  <li>根据状态计算出虚拟 DOM 对象</li>
  <li>根据虚拟 DOM 生成真实的 Dom 结构</li>
  <li>挂载 Dom 到页面中</li>
</ol>
<p>但是在测试中，我们不需要挂载组件到页面中，只需要有一个 Dom 环境即可，如果你不需要完整的渲染组件甚至可以没有 Dom 环境。</p>
<p><strong><a href="http://airbnb.io/enzyme/">Enzyme</a></strong></p>
<p>Enzyme（酶，催化剂）是 Airbnb 公司提供的 React 测试工具，提供了 Shallow Rendering（浅渲染） | Full Rendering （全渲染）| Static Rendering （静态渲染）几种方式来渲染方式来测试 React 组件，一般常用浅渲染的方式进行测试。</p>
<blockquote>
  <p>使用 Enzyme 进行测试前需要先初始化 React 适配器，具体配置请查看官方手册</p>
</blockquote>
<ul>
  <li>
    <p>Shallow Rendering</p>
    <p>只渲染组件最外层结构，不会渲染子组件</p>
    <p>一个完整的 Shallow 渲染测试的实例：</p>
    <div class="remark-highlight">
      <pre class="language-jsx"><code class="language-jsx"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> classnames</span> <span class="token keyword module">from</span> <span class="token string">"classnames"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ClassName</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"../helper"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> styles</span> <span class="token keyword module">from</span> <span class="token string">"./styles.desktop.css"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">AppBar</span><span class="token operator">:</span> <span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">StatelessComponent</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>any</span><span class="token punctuation">></span></span><span class="token plain-text"> = function AppBar({</span>
<span class="token plain-text">  className,</span>
<span class="token plain-text">  children,</span>
<span class="token plain-text">  ...props</span>
<span class="token plain-text">} = {}) </span><span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span>
      <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>
        styles<span class="token punctuation">[</span><span class="token string">"app-bar"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token maybe-class-name">ClassName</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">BorderTopColor</span></span><span class="token punctuation">,</span>
        className
      <span class="token punctuation">)</span><span class="token punctuation">}</span></span>
      <span class="token spread"><span class="token punctuation">{</span><span class="token spread operator">...</span>props<span class="token punctuation">}</span></span>
    <span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;</span>
<span class="token plain-text"></span>
<span class="token plain-text">export default AppBar;</span>
</code></pre>
    </div>
    <div class="remark-highlight">
      <pre class="language-jsx"><code class="language-jsx"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> shallow <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"enzyme"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"chai"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">AppBar</span></span> <span class="token keyword module">from</span> <span class="token string">"../ui.desktop"</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"ShareWebUI"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"AppBar@desktop"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"#render"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"默认渲染"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">AppBar</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"正确渲染子节点"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">AppBar</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">test</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span><span class="token class-name">AppBar</span></span><span class="token punctuation">></span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token method function property-access">contains</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text">test</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"允许设置ClassName"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">AppBar</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token method function property-access">hasClass</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"允许设置其他自定义props"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> wrapper <span class="token operator">=</span> <span class="token function">shallow</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">AppBar</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">age</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token number">123</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token method function property-access">props</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token method function property-access">include</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    </div>
  </li>
  <li>
    <p>Full Rendering</p>
    <p>渲染组件真实的 Dom 结构，如果需要测试原生事件，则必须使用这种渲染方式。</p>
  </li>
  <li>
    <p>Static Rendering</p>
    <p>类似于爬虫拿到的结果，拿到页面的 HTML 字符串，使用<a href="https://github.com/cheeriojs/cheerio">Cheerio</a>进行操作。</p>
  </li>
</ul>
<blockquote>
  <p>Enzyme 的浅渲染模式下的事件模拟并非是真的事件触发，实际上它是一种“障眼法”实现，例如 buttonWrapper.simulate('click')只是简单了调用传给 Button 组件的 onClick 参数的那个函数而已。</p>
  <p>具体描述：<a href="http://airbnb.io/enzyme/docs/future.html">http://airbnb.io/enzyme/docs/future.html</a></p>
  <p>Enzyme 的很多坑：<a href="http://airbnb.io/enzyme/docs/guides/migration-from-2-to-3.html">http://airbnb.io/enzyme/docs/guides/migration-from-2-to-3.html</a></p>
  <p>如果在异步操作中调用 setState(),则测试时需要在下一个时钟周期中进行断言（类似的问题较多）：</p>
  <div class="remark-highlight">
    <pre class="language-js"><code class="language-js"><span class="token comment">/* 模拟点击 */</span>
wrapper<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token string">"UIIcon"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">simulate</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token method function property-access">state</span><span class="token punctuation">(</span><span class="token string">"loadStatus"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 点击立即改变加载状态为正在加载</span>
<span class="token comment">/* 在promise.then 中设置setState,因此需要在下一个时钟进行断言 */</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token method function property-access">state</span><span class="token punctuation">(</span><span class="token string">"loadStatus"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
  </div>
</blockquote>
<h4 id="集成测试integration-testing">集成测试（Integration Testing）</h4>
<p>集成测试是指在单元测试的基础上，将已测试过的单元测试函数进行组合集成暴露出的高层函数或类的封装，对这些函数或类进行的测试。</p>
<p>集成测试最大的难点就是颗粒度较大，逻辑更加复杂，外部因素更多，无法保证测试的可控和独立性。解决方式是使用测试桩（测试替身），即将调用的子函数或模块替换掉，即可以隐藏子模块的细节并且可以控制子模块的行为以达到预期的测试。（这里的前提是子模块已经经过完整的单元测试进行覆盖，因此可以假定为子模块状态可知。）</p>
<p>Typescript 编译成 Commonjs：</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token comment">// 编译前</span>
<span class="token keyword module">import</span> <span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token constant">B</span> <span class="token keyword module">from</span> <span class="token string">"B"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> fn <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"C"</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">B</span><span class="token punctuation">.</span><span class="token property-access">fn</span><span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fn<span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name">A1</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 编译后</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"require"</span><span class="token punctuation">,</span> <span class="token string">"exports"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C_1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">"use strict"</span><span class="token punctuation">;</span>
  <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"__esModule"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">B</span><span class="token punctuation">.</span><span class="token property-access">fn</span><span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">C_1</span><span class="token punctuation">.</span><span class="token property-access">fn</span><span class="token punctuation">.</span><span class="token method function property-access">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  exports<span class="token punctuation">.</span><span class="token constant">A</span> <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token constant">A1</span> <span class="token operator">=</span> <span class="token doc-comment comment">/** <span class="token keyword">@class</span> */</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token constant">A1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token constant">A1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  exports<span class="token punctuation">.</span><span class="token constant">A1</span> <span class="token operator">=</span> <span class="token constant">A1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>导出的所有函数和类都在 exports 对象下，由于在调用时其实是调用的 exports.exportName,如果希望 Stub 则需要 Stub exports 下的属性即可，Sinon 提供的 stub 功能允许我们修改一个对象下的任意属性，注意必须是在一个对象下，也就是说不能直接<code>sinon.stub(fn)</code>，只能<code>sinon.stub(obj,'fnName')</code>。而在 ES6 中可以通过<code>import * as moduleName from ‘moduleName ’</code> 将整个模块导出到单个对象上，就可以解决 Stub 的问题。</p>
<p>考虑有下面的模块依赖：</p>
<p>
  <img src="http://ow67vzejn.bkt.clouddn.com/18-6-15/95861106.jpg" alt="">
</p>
<p>其中模块 A 依赖模块 B 和 C，模块 B 又依赖模块 C，这种情况下我们可以选择只 Stub 模块 C，这时候在模块 B 中的 C 模块也同样会被 Stub 影响，最好的方式是同时 Stub 模块 B 和模块 C。</p>
<h5 id="煎蛋的栗子">煎蛋的栗子</h5>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> clientAPI <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../../clientapi/clientapi'</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 通过相对路径获取缓存信息
 * <span class="token keyword">@param</span> <span class="token parameter">param0</span> 参数对象
 * <span class="token keyword">@param</span> <span class="token parameter">param0<span class="token punctuation">.</span>relPath</span> 相对路径
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token literal-property property">getInfoByPath</span><span class="token operator">:</span> <span class="token maybe-class-name">Core</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">APIs</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Client</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Cache</span></span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access"><span class="token maybe-class-name">GetInfoByPath</span></span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> relPath <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">clientAPI</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">,</span> <span class="token string">'GetInfoByPath'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> relPath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'chai'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> stub <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sinon'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> clientapi</span> <span class="token keyword module">from</span> <span class="token string">'../../../clientapi/clientapi'</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getInfoByPath<span class="token punctuation">,</span> getUnsyncLog<span class="token punctuation">,</span> getUnsyncLogNum <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cache'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token string">'stub'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">stub</span><span class="token punctuation">(</span>clientapi<span class="token punctuation">,</span> <span class="token string">'clientAPI'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token string">'restore'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        clientapi<span class="token punctuation">.</span><span class="token property-access">clientAPI</span><span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'通过相对路径获取缓存信息#getInfoByPath'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">getInfoByPath</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">relPath</span><span class="token operator">:</span> <span class="token string">'relPath'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>clientapi<span class="token punctuation">.</span><span class="token property-access">clientAPI</span><span class="token punctuation">.</span><span class="token property-access">args</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">'cache'</span><span class="token punctuation">)</span> <span class="token comment">// 请求资源正确</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>clientapi<span class="token punctuation">.</span><span class="token property-access">clientAPI</span><span class="token punctuation">.</span><span class="token property-access">args</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token string">'GetInfoByPath'</span><span class="token punctuation">)</span> <span class="token comment">// 请求方法正确</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>clientapi<span class="token punctuation">.</span><span class="token property-access">clientAPI</span><span class="token punctuation">.</span><span class="token property-access">args</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">deep</span><span class="token punctuation">.</span><span class="token method function property-access">equal</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">relPath</span><span class="token operator">:</span> <span class="token string">'relPath'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 请求体正确</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>）

</code></pre>
</div>
<p>或者使用 Sinon 提供的 Sandbox，在 restore 时更加简单，不需要单独 restore 每一个被 Stub 的对象。</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> rsaEncrypt <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../util/rsa/rsa'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getNew<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../apis/eachttp/auth1/auth1'</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * 认证用户
 * <span class="token keyword">@param</span> <span class="token parameter">account</span> <span class="token punctuation">{</span>string<span class="token punctuation">}</span>
 * <span class="token keyword">@param</span> <span class="token parameter">password</span> <span class="token punctuation">{</span>string<span class="token punctuation">}</span>
 */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">auth</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">account</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">ostype</span><span class="token operator">:</span> number<span class="token punctuation">,</span> vcodeinfo<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Core</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">APIs</span></span><span class="token punctuation">.</span><span class="token constant">EACHTTP</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Auth1</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">VcodeInfo</span></span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Core</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">APIs</span></span><span class="token punctuation">.</span><span class="token constant">EACHTTP</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AuthInfo</span></span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">getNew</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        account<span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">deviceinfo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">ostype</span><span class="token operator">:</span> ostype
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        vcodeinfo
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* ↑↑↑↑被测函数↑↑↑↑ */</span>
<span class="token comment">/* ↓↓↓↓测试代码↓↓↓↓ */</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createSandbox <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sinon'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> auth1</span> <span class="token keyword module">from</span> <span class="token string">'../apis/eachttp/auth1/auth1'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> rsa</span> <span class="token keyword module">from</span> <span class="token string">'../../util/rsa/rsa'</span>
<span class="token keyword">const</span> sandbox <span class="token operator">=</span> <span class="token function">createSandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'auth'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token string">'stub'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token arrow operator">=></span><span class="token punctuation">{</span>
        sandbox<span class="token punctuation">.</span><span class="token method function property-access">stub</span><span class="token punctuation">(</span>rsa<span class="token punctuation">,</span><span class="token string">'rsaEncrypt'</span><span class="token punctuation">)</span>
        sandbox<span class="token punctuation">.</span><span class="token method function property-access">stub</span><span class="token punctuation">(</span>auth1<span class="token punctuation">,</span><span class="token string">'getNew'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token string">'restore'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token arrow operator">=></span><span class="token punctuation">{</span>
        sandbox<span class="token punctuation">.</span><span class="token method function property-access">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'认证用户#auth'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">auth</span><span class="token punctuation">(</span><span class="token string">'account'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token string">'12140661-e35b-4551-84cf-ce0e513d1596'</span><span class="token punctuation">,</span> <span class="token literal-property property">vcode</span><span class="token operator">:</span> <span class="token string">'1abc'</span><span class="token punctuation">,</span> <span class="token literal-property property">ismodif</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        rsa<span class="token punctuation">.</span><span class="token property-access">rsaEncrypt</span><span class="token punctuation">.</span><span class="token method function property-access">returns</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token comment">// 控制返回值</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>rsa<span class="token punctuation">.</span><span class="token property-access">rsaEncrypt</span><span class="token punctuation">.</span><span class="token method function property-access">calledWith</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>auth1<span class="token punctuation">.</span><span class="token property-access">getNew</span><span class="token punctuation">.</span><span class="token method function property-access">calledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">account</span><span class="token operator">:</span> <span class="token string">'account'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">deviceinfo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">ostype</span><span class="token operator">:</span> <span class="token number">1</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">vcodeinfo</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">uuid</span><span class="token operator">:</span> <span class="token string">'12140661-e35b-4551-84cf-ce0e513d1596'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">vcode</span><span class="token operator">:</span> <span class="token string">'1abc'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">ismodif</span><span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">to</span><span class="token punctuation">.</span><span class="token property-access">be</span><span class="token punctuation">.</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<blockquote>
  <p>参考文档：</p>
  <ul>
    <li><a href="http://sinonjs.org/releases/v6.0.0/stubs/">Stubs - Sinon.JS</a> Stub 的相关概念和使用</li>
    <li><a href="http://sinonjs.org/releases/v6.0.0/sandbox/">Sandboxes - Sinon.JS</a> Sandbox（沙盒）的相关概念和使用</li>
  </ul>
</blockquote>
<h4 id="端到端测试e2e-testing">端到端测试（E2E Testing）</h4>
<p>端到端测试是最顶层的测试，即完全作为一个用户一样将程序作为一个完全的黑盒，打开应用程序模拟输入，检查功能以及界面是否正确。</p>
<p>端到端测试需要解决的一些问题：</p>
<ul>
  <li>
    <p>环境问题</p>
    <p>即如何保证每次执行测试前的环境是“干净的”，比如需要检查列表为空的表现，如果上一次测试新增了列表，则后一次测试将无法得到列表为空的状态。</p>
    <p>最简单的解决方式是在所有测试执行前或测试执行后调用外部脚本清除数据库等，或者可以通过拦截请求并自定义响应的方式来解决（这样会导致测试复杂度变高，并且不够”真实“）。</p>
  </li>
  <li>
    <p>元素查找</p>
    <p>如果代码经常变动，组件结构经常变化，如果根据 DOM 结构来查找操作元素，那么你将陷入维护选择器的地狱中。最佳实践是使用 test-id 的方式，但是这种方式需要开发人员和测试人员配合，在可操作元素上定义语义化的 test-id。</p>
  </li>
  <li>
    <p>操作等待</p>
    <p>诸如异步网络请求导致界面变化，或界面动画等，将使得获取操作元素的时机未知。解决方案持续等待直到监听的请求完成，期望的元素成功获取到。</p>
  </li>
  <li>
    <p>使用操作而不是断言</p>
    <p>应该更多的依赖操作，而不是依赖断言。例如如果某个操作依赖元素 A 存在，你不需要"判断元素 A 在页面中是否存在"，而应该去"直接获取元素 A，并操作"，因为如果元素 A 不存在，那么肯定将获取不到，断言后的操作将没有意义，因此可以直接使用操作取代断言等待功能。</p>
  </li>
</ul>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[Stroybook]]></title>
            <link>https://jiangwenyang.com/posts/Stroybook</link>
            <guid>https://jiangwenyang.com/posts/Stroybook</guid>
            <pubDate>Wed, 28 Mar 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[Storybook是一个可视化的UI 开发环境，本文简单介绍如何进行搭建它并进行使用]]></description>
            <content:encoded><![CDATA[
<h2 id="什么是-storybook">什么是 Storybook?</h2>
<p>Stroybook 是一个可视化的 UI 开发环境，通过 Stroybook 你能快速的渲染展示 UI 组件，将 UI 组件与项目隔离，并且通过提供的丰富的插件来提升开发体验。</p>
<h2 id="使用-strorybook">使用 Strorybook</h2>
<p>Stroybook 不仅仅可以应用于 React 项目，同时也支持 Vue 和 Angular，由于目前项目使用 React，并且 Storybook 对 React 的支持度更好，因此在此只介绍 Stroybook for React。</p>
<h3 id="1-安装">1. 安装</h3>
<p>安装配置 Storybook 官方提供了两种方式，一种是使用提供的 cli 工具进行快速生成，一种是手动安装配置。推荐自己手动配置安装以熟悉 Storybook。</p>
<h4 id="11-快速生成">1.1 快速生成</h4>
<p>
  Stroybook 官方提供了快速生成 Stroybook 项目骨架的命令行工具，这个工具可以在已有项目下使用。
  在项目根目录下执行一下命令：
</p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i -g @storybook/cli
$ getstorybook
</code></pre>
</div>
<p>上面的命令将会为你快速生成对应你的项目的 storybook。将会安装对应的依赖，在根目录下创建<code>.storybook</code>配置目录并生成对应的配置文件，创建<code>stories</code>目录并创建默认的<code>stories</code>的 demo</p>
<h4 id="12-自定义配置">1.2 自定义配置</h4>
<p>如果不想全局安装命令行工具，并且希望自定义 Stroybook，推荐自定义安装配置 Stroybook。</p>
<ol>
  <li>安装<code>@storybook/react</code></li>
</ol>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> -D @storybook/react
</code></pre>
</div>
<ol start="2">
  <li>安装 react，react-dom，babel-core</li>
</ol>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> react react-dom
<span class="token function">yarn</span> <span class="token function">add</span> -D babel-core
</code></pre>
</div>
<blockquote>
  <p>Storybook 官方没有给出兼容性列表，但实测无法使用 React 0.14</p>
</blockquote>
<ol start="3">
  <li>
    添加 NPM script
    编辑<code>package.json</code>，添加启动 Storybook 的 script 字段
  </li>
</ol>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"storybook"</span><span class="token operator">:</span> <span class="token string">"start-storybook -p 9001 -c .storybook"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<blockquote>
  <p><code>-c</code> 参数后跟配置文件所处目录，不使用<code>-c</code>时将默认使用<code>.storybook</code>目录下的配置文件<code>config.js</code></p>
</blockquote>
<h3 id="2-配置">2. 配置</h3>
<blockquote>
  <p>如果使用快速生成则下面这些配置文件已经帮你生成好了无需再自己配置。</p>
</blockquote>
<p>
  在根目录下创建<code>.storybook</code>文件夹，然后在该目录下创建<code>config.js</code>文件。
  最简单的配置：
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> configure <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loadStories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../stories/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// You can require as many stories as you need.</span>
<span class="token punctuation">}</span>

<span class="token function">configure</span><span class="token punctuation">(</span>loadStories<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>上面的配置文件将会使用<code>stories/index.js</code>中的 stories，如果你有多个 stories，每次写 stories 的时候需要对应的进行 require，比较繁琐。如果使用 Webpack，可以使用 Webpack 的<a href="https://webpack.js.org/guides/dependency-management/">require.context</a>语法：</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> configure <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loadStories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storiesContext <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token method function property-access">context</span><span class="token punctuation">(</span><span class="token string">"../src"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>stories<span class="token special-escape escape">\.</span>tsx<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  storiesContext<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>storiesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 将会加载src所有子目录下的以.stories.tsx结尾的模块</span>
  <span class="token comment">// You can require as many stories as you need.</span>
<span class="token punctuation">}</span>

<span class="token function">configure</span><span class="token punctuation">(</span>loadStories<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<h3 id="3-写-stories">3. 写 stories</h3>
<p>在组件目录下新建对应 stories 文件，例如在 Button 组件目录下新建<code>stories/Button.stories.tsx</code></p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> storiesOf <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> action <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-actions"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Button</span></span> <span class="token keyword module">from</span> <span class="token string">"../ui.desktop.tsx"</span><span class="token punctuation">;</span>

<span class="token function">storiesOf</span><span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">"with text"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"clicked"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Hello</span> <span class="token maybe-class-name">Button</span><span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Button</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">"with some emoji"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"clicked"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>😀 😎 👍 💯<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Button</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>
  然后执行<code>npm run storybook</code>或者<code>yarn storybook</code>打开<a href="localhost:9001">localhost:9001</a>将看到类似下面这样的界面
  
  <img src="http://ow67vzejn.bkt.clouddn.com/18-1-31/1015387.jpg" alt="">
</p>
<h3 id="4-使用-addon">4. 使用 addon</h3>
<p>
  Storybook 通过插件的方式使用额外的功能，主要有两种插件：
  <strong>Decorators 类装饰器插件</strong>
  Decorators 插件又分为两种:
</p>
<ol>
  <li>
    Wrapper Components
    就是普通的 react 容器组件，简单的将你需要 story 的组件包裹在其中。
  </li>
</ol>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> styles <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"center"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Center</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
</div>
<ol start="2">
  <li>
    Storybook Decorators
    扩展一个函数作为 storybook decorator。
  </li>
</ol>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> storiesOf <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> action <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-actions"</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Button</span></span> <span class="token keyword module">from</span> <span class="token string">"./button"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> styles <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"center"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">CenterDecorator</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">storyFn</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token function">storyFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token function">storiesOf</span><span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">addDecorator</span><span class="token punctuation">(</span><span class="token maybe-class-name">CenterDecorator</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">"with text"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"clicked"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Hello</span> <span class="token maybe-class-name">Button</span><span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Button</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">"with some emojies"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"clicked"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>😀 😎 👍 💯<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Button</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<blockquote>
  <p>使用<code>.addDecorator(Decorator)</code>语法代码更加简洁,如果要使用全局的 Decorator 可以在<code>config.js</code>中配置全局的<code>Decorator</code>，将会应用到所有的 stories</p>
</blockquote>
<p>例如需要居中显示所有的 stories：</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> configure<span class="token punctuation">,</span> addDecorator<span class="token punctuation">,</span> setAddon <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>
<span class="token function">addDecorator</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">stories</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
  <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">"center"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token function">stories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>
  <strong>Native Addons 原生插件</strong>
  原生插件能在包裹 stories 之前提供基于 Storybook 平台的额外特性，例如 storybook-actions 插件。
</p>
<p>使用这两种插件前，我们都需要先在<code>.storybook</code>目录下新建<code>addons.js</code>来注册对应的插件</p>
<div class="remark-highlight">
  <pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token string">"@storybook/addon-actions/register"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@storybook/addon-links/register"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@storybook/addon-notes/register"</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>插件的具体使用配置需要查看插件自己的文档。</p>
<h3 id="5-自定义-webpack-配置">5. 自定义 Webpack 配置</h3>
<p>
  当使用 storybook 时，Storybook 将会使用自己默认的 webpack 配置,使用的是 create-react-app 的 webpack 配置，一般而言适用于绝大多数项目。如果想自定义 webpack 有下面几种方式：
  <strong>Extend Mode (扩展模式)</strong>
  在<code>.storybook</code>目录下新建文件<code>webpack.config.js</code>，导出一个<strong>object</strong>
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>scss<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"style-loader"</span><span class="token punctuation">,</span> <span class="token string">"css-loader"</span><span class="token punctuation">,</span> <span class="token string">"sass-loader"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">include</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>扩展模式下可以更改除：</p>
<ul>
  <li>entry</li>
  <li>output</li>
  <li>js loader with babel</li>
</ul>
<p>这几项外所有的 webpack 配置项，Storybook 将会将你的自定义配置项作为默认配置的扩展来启动 webpack。</p>
<p>
  <strong>Full Control Mode (完全控制模式)</strong>
  通过导出一个函数，函数接受两个参数 storybookBaseConfig 和 configType，一个是 Storybook 的基础配置对象，一个是当前的环境（'DEVELOPMENT' or 'PRODUCTION'），然后通过修改 storybookBaseConfig 后返回自定义的配置对象达到完全控制的目的。
  官方的 DMEO：
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Export a function. Accept the base config as the only param.</span>
module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">storybookBaseConfig<span class="token punctuation">,</span> configType</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// configType has a value of 'DEVELOPMENT' or 'PRODUCTION'</span>
  <span class="token comment">// You can change the configuration based on that.</span>
  <span class="token comment">// 'PRODUCTION' is used when building the static version of storybook.</span>

  <span class="token comment">// Make whatever fine-grained changes you need</span>
  storybookBaseConfig<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">.</span><span class="token property-access">rules</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>scss<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"style-loader"</span><span class="token punctuation">,</span> <span class="token string">"css-loader"</span><span class="token punctuation">,</span> <span class="token string">"sass-loader"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the altered config</span>
  <span class="token keyword control-flow">return</span> storybookBaseConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>尽量不要去更改下面这几项：</p>
<ul>
  <li>entry</li>
  <li>output</li>
  <li>first loader in the module.loaders (Babel loader for JS)</li>
  <li>all existing plugins</li>
</ul>
<p>
  <strong>Full control mode + default （完全控制+默认配置 模式）</strong>
  和完全配置模式几乎一样，唯一的区别是导出的函数多了一个参数 defaultConfig，当导出的函数有三个参数时将会使用这种模式。
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">baseConfig<span class="token punctuation">,</span> env<span class="token punctuation">,</span> defaultConfig</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Extend defaultConfig as you need.</span>

  <span class="token comment">// For example, add typescript loader:</span>
  defaultConfig<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">.</span><span class="token property-access">rules</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span><span class="token group punctuation">(</span>ts<span class="token alternation keyword">|</span>tsx<span class="token group punctuation">)</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">include</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../src"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">"ts-loader"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  defaultConfig<span class="token punctuation">.</span><span class="token property-access">resolve</span><span class="token punctuation">.</span><span class="token property-access">extensions</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">".ts"</span><span class="token punctuation">,</span> <span class="token string">".tsx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> defaultConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<blockquote>
  <p>
    建议使用扩展模式，配置比较简单。如果需要根据不同的环境进行不同的编译配置，使用全控制模式配置。
    Storybook 的基础配置中只包含了 babel-loader 和 md 解析用的 loader，默认配置中配置了例如 css、json、字体文件、媒体文件相关的 loader，可以在 node_modules@storybook\react\src\server\config 下看到对应的 webpack 配置文件。
  </p>
</blockquote>
<h3 id="6-注入-script-或-css">6. 注入 script 或 css</h3>
<p>如果你的 UI 库依赖全局的 script 或者 css，可以通过 Storybook 提供的注入的方式。</p>
<ol>
  <li>
    组件预览 iframe 注入
    在<code>./stroybook</code>目录下新建<code>preview-head.html</code>,里面的 srcipt 或 css 标签将注入到预览区域的 iframe 中，在 stries 加载前被注入。
    例如希望每个 UI 组件使用 reset.css
    在<code>preview-head.html</code>中添加
  </li>
</ol>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token operator">&#x3C;</span>style<span class="token operator">></span>
<span class="token operator">*</span><span class="token punctuation">{</span>
	<span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>style<span class="token operator">></span>
</code></pre>
</div>
<ol start="2">
  <li>
    Stroybook 平台注入
    在<code>./stroybook</code>目录下新建<code>manager-head.html</code>,里面的 script 或 css 标签将注入到 Stroybook 平台下，将在 Stroybook React UI 加载前被注入。
  </li>
</ol>
<h2 id="配置参考">配置参考</h2>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> configure<span class="token punctuation">,</span> addDecorator<span class="token punctuation">,</span> setAddon <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>

<span class="token comment">/* 导入storybook插件 */</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> setOptions <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-options"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">JSXAddon</span></span> <span class="token keyword module">from</span> <span class="token string">"storybook-addon-jsx"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> withKnobs <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-knobs/react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> withDocs <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"storybook-readme"</span><span class="token punctuation">;</span>

<span class="token comment">/* 通用storybook底部md */</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">Doc_Footer</span></span> <span class="token keyword module">from</span> <span class="token string">"./Doc_Footer.md"</span><span class="token punctuation">;</span>

<span class="token comment">/* 设置Storybook UI */</span>
<span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"AnyShare"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">"https://anyshare.eisoo.com"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">goFullScreen</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">showLeftPanel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">showDownPanel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">showSearchBox</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">downPanelInRight</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 设置使用JSXAddon，在侧边栏显示渲染区域组件对应的JSX */</span>
<span class="token function">setAddon</span><span class="token punctuation">(</span><span class="token maybe-class-name">JSXAddon</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

withDocs<span class="token punctuation">.</span><span class="token method function property-access">addFooterDocs</span><span class="token punctuation">(</span><span class="token maybe-class-name">Doc_Footer</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当使用withDocs时，使用通用底部md</span>

<span class="token comment">/* 全局story装饰器 */</span>
<span class="token function">addDecorator</span><span class="token punctuation">(</span>withKnobs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用addon-knobs装饰器，允许自定义组件参数，具体参数需要在story中定义</span>

<span class="token comment">/* 加载story */</span>
<span class="token keyword">function</span> <span class="token function">loadStories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> storiesContext <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token method function property-access">context</span><span class="token punctuation">(</span><span class="token string">"../src"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>stories<span class="token special-escape escape">\.</span>tsx<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  storiesContext<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>storiesContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">configure</span><span class="token punctuation">(</span>loadStories<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>ShareWebUI/.sotrybook/addon.js --- Storybook 注册插件配置文件</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token string">"@storybook/addon-options/register"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token string">"@storybook/addon-actions/register"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token string">"@storybook/addon-links/register"</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token string">"@storybook/addon-knobs/register"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token string">"storybook-addon-jsx/register"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token string">"storybook-readme/register"</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>ShareWebUI/.storybook/webpack.config.js --- 自定义 webpack 配置</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">ExtractTextPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"extract-text-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>tsx<span class="token quantifier number">?</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"ts-loader"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">transpileOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>json<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"json-loader"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>css<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token maybe-class-name">ExtractTextPlugin</span><span class="token punctuation">.</span><span class="token method function property-access">extract</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"css-loader"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token literal-property property">importLoaders</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token literal-property property">localIdentName</span><span class="token operator">:</span> <span class="token string">"[path][name]---[local]"</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"postcss-loader"</span><span class="token punctuation">,</span>
              <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"../../postcss.config.js"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>png<span class="token anchor function">$</span><span class="token alternation keyword">|</span><span class="token special-escape escape">\.</span>gif<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"url-loader"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span><span class="token group punctuation">(</span>eot<span class="token alternation keyword">|</span>otf<span class="token alternation keyword">|</span>webp<span class="token alternation keyword">|</span>svg<span class="token alternation keyword">|</span>ttf<span class="token alternation keyword">|</span>woff<span class="token alternation keyword">|</span>woff2<span class="token group punctuation">)</span><span class="token group punctuation">(</span><span class="token special-escape escape">\?</span><span class="token char-set class-name">.</span><span class="token quantifier number">*</span><span class="token group punctuation">)</span><span class="token quantifier number">?</span><span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"base64-font-loader"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"assets/fonts/[name].[ext]"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>swf<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">"file-loader"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"assets/[name].[ext]"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">/* 使用storybook的默认md配置 */</span>
      <span class="token comment">// {</span>
      <span class="token comment">//     test: /\.md$/,</span>
      <span class="token comment">//     use: [{</span>
      <span class="token comment">//             loader: 'html-loader',</span>
      <span class="token comment">//         },</span>
      <span class="token comment">//         {</span>
      <span class="token comment">//             loader: 'markdown-loader',</span>
      <span class="token comment">//         },</span>
      <span class="token comment">//     ],</span>
      <span class="token comment">// },</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ExtractTextPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">"[name].css"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">allChunks</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">".ts"</span><span class="token punctuation">,</span> <span class="token string">".tsx"</span><span class="token punctuation">,</span> <span class="token string">".js"</span><span class="token punctuation">,</span> <span class="token string">".jsx"</span><span class="token punctuation">,</span> <span class="token string">".css"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>ShareWebUI/src/Button/stories/Button.stroies.tsx --- stories 文件</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> storiesOf <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> action <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-actions"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  object<span class="token punctuation">,</span>
  number<span class="token punctuation">,</span>
  text<span class="token punctuation">,</span>
  boolean<span class="token punctuation">,</span>
  select<span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@storybook/addon-knobs/react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> withReadme<span class="token punctuation">,</span> withDocs <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"storybook-readme"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">ReadmeDoc</span></span> <span class="token keyword module">from</span> <span class="token string">"../document/Button.md"</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Button</span></span> <span class="token keyword module">from</span> <span class="token string">"../ui.desktop"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> typeOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">button</span><span class="token operator">:</span> <span class="token string">"button"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">submit</span><span class="token operator">:</span> <span class="token string">"submit"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">reset</span><span class="token operator">:</span> <span class="token string">"reset"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">regular</span><span class="token operator">:</span> <span class="token string">"regular"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">dark</span><span class="token operator">:</span> <span class="token string">"dark"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">storiesOf</span><span class="token punctuation">(</span><span class="token string">"Button@desktop"</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">addDecorator</span><span class="token punctuation">(</span><span class="token function">withDocs</span><span class="token punctuation">(</span><span class="token maybe-class-name">ReadmeDoc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">addDecorator</span><span class="token punctuation">(</span><span class="token function">withReadme</span><span class="token punctuation">(</span><span class="token maybe-class-name">ReadmeDoc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">addWithJSX</span><span class="token punctuation">(</span><span class="token string">"Button"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span>
      type<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> typeOptions<span class="token punctuation">,</span> <span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      theme<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"theme"</span><span class="token punctuation">,</span> theme<span class="token punctuation">,</span> <span class="token string">"regular"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      disabled<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">boolean</span><span class="token punctuation">(</span><span class="token string">"disabled"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"button-click"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      code<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"icon"</span><span class="token punctuation">,</span> <span class="token string">"\uf077"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      minWidth<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token string">"minWidth"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token string">"width"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"className"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      onMouseDown<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"onMouseDown"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      onMount<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token string">"onMount"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token string">"fallback"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token punctuation">{</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Button</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>ShareWebUI/src/Button/ui.desktop.tsx --- 对应的 Button 组件</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">React</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> noop <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"lodash"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> classnames</span> <span class="token keyword module">from</span> <span class="token string">"classnames"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">UIIcon</span></span> <span class="token keyword module">from</span> <span class="token string">"../UIIcon/ui.desktop"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> styles</span> <span class="token keyword module">from</span> <span class="token string">"./styles.desktop.css"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">Button</span><span class="token operator">:</span> <span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">StatelessComponent</span></span><span class="token operator">&#x3C;</span><span class="token constant">UI</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Button</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Props</span></span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Button</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type <span class="token operator">=</span> <span class="token string">"button"</span><span class="token punctuation">,</span>
  disabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  theme <span class="token operator">=</span> <span class="token string">"regular"</span><span class="token punctuation">,</span>
  icon<span class="token punctuation">,</span>
  minWidth<span class="token punctuation">,</span>
  width<span class="token punctuation">,</span>
  className<span class="token punctuation">,</span>
  onClick <span class="token operator">=</span> noop<span class="token punctuation">,</span>
  onMouseDown <span class="token operator">=</span> noop<span class="token punctuation">,</span>
  onMount <span class="token operator">=</span> noop<span class="token punctuation">,</span>
  children<span class="token punctuation">,</span>
  fallback<span class="token punctuation">,</span>
  <span class="token spread operator">...</span>otherProps
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button
      type<span class="token operator">=</span><span class="token punctuation">{</span>type<span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> minWidth<span class="token punctuation">,</span> width <span class="token punctuation">}</span><span class="token punctuation">}</span>
      disabled<span class="token operator">=</span><span class="token punctuation">{</span>disabled<span class="token punctuation">}</span>
      className<span class="token operator">=</span><span class="token punctuation">{</span><span class="token function">classnames</span><span class="token punctuation">(</span>styles<span class="token punctuation">[</span><span class="token string">"button"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> styles<span class="token punctuation">[</span>theme<span class="token punctuation">]</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>styles<span class="token punctuation">[</span><span class="token string">"disabled"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> disabled<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>disabled <span class="token operator">&#x26;&#x26;</span> <span class="token function">onClick</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">}</span>
      onMouseDown<span class="token operator">=</span><span class="token punctuation">{</span>onMouseDown<span class="token punctuation">}</span>
      ref<span class="token operator">=</span><span class="token punctuation">{</span>onMount<span class="token punctuation">}</span>
      <span class="token punctuation">{</span><span class="token spread operator">...</span>otherProps<span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token punctuation">{</span>icon <span class="token operator">?</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span>span className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">[</span><span class="token string">"icon"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">UIIcon</span>
            size<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">16</span><span class="token punctuation">}</span>
            code<span class="token operator">=</span><span class="token punctuation">{</span>icon<span class="token punctuation">}</span>
            fallback<span class="token operator">=</span><span class="token punctuation">{</span>fallback<span class="token punctuation">}</span>
            color<span class="token operator">=</span><span class="token punctuation">{</span>theme <span class="token operator">===</span> <span class="token string">"dark"</span> <span class="token operator">?</span> <span class="token string">"#fff"</span> <span class="token operator">:</span> <span class="token string">"#757575"</span><span class="token punctuation">}</span>
          <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span>
      <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span>span<span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">Button</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>参考文档：</p>
<ul>
  <li><a href="https://storybook.js.org/basics/introduction/">Storybook 官方配置文档</a></li>
  <li><a href="https://github.com/storybooks/storybook/tree/master/addons/actions">插件 Action 配置文档</a></li>
  <li><a href="https://github.com/storybooks/storybook/tree/master/addons/knobs">插件 Knobs 配置文档</a></li>
  <li><a href="https://github.com/storybooks/storybook/tree/master/addons/options">插件 Options 配置文档</a></li>
  <li><a href="https://github.com/tuchk4/storybook-readme">插件 Readme 配置文档</a></li>
  <li><a href="https://github.com/storybooks/addon-jsx">插件 JSX preview 配置文档</a></li>
</ul>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[Git Hooks]]></title>
            <link>https://jiangwenyang.com/posts/Git Hooks</link>
            <guid>https://jiangwenyang.com/posts/Git Hooks</guid>
            <pubDate>Mon, 12 Mar 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[介绍Git Hooks是什么，以及如何使用]]></description>
            <content:encoded><![CDATA[
<h2 id="什么是-git-hooks">什么是 Git Hooks</h2>
<p>Git Hooks（Git 钩子）是 Git 提供的当特定动作如提交、推送等 Git 行为发生时执行的自定义脚本。主要分为客户端脚本和服务器端脚本。</p>
<h3 id="git-hooks-的安装">Git Hooks 的安装</h3>
<p>其实当初始化一个 Git 项目的时候，hooks 就已经被安装到项目中，只是默认未启用。当执行<code>git init</code>的时候，Git 会初始化示例脚本到<code>.git/hooks</code>目录中。</p>
<p>如果想启用这些 hooks 非常简单，只需要去掉<code>.sample</code>后缀即可启用。示例代码是使用 shell 编写的,但是 git 并没没有显示编写 hooks 使用的语言,任何可执行脚本都可以使用。</p>
<blockquote>
  <p><code>.git</code>目录无法加入到版本控制中，因为每次 clone 一个新的仓库的时候都会新生成<code>.git</code>目录。</p>
  <p>由于这个特性，因此只能将 hooks 存储到其他目录，通过软链接或者手动拷贝的方式拷贝到<code>.git/hooks</code>目录下，但是这样的问题是当更新或新增 hooks 脚本的时候需要重新建立与<code>.git/hooks</code>的关系。</p>
</blockquote>
<h3 id="客户端钩子">客户端钩子</h3>
<p>客户端钩子主要有提交工作流钩子、电子邮件工作流钩子和其它钩子。</p>
<table>
  <thead>
    <tr>
      <th>钩子类型</th>
      <th>钩子名称</th>
      <th>触发时机</th>
      <th>钩子参数</th>
      <th>可中止</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>提交工作流钩子</td>
      <td>pre-commit</td>
      <td>键入提交信息前，即生成本次 commit 对象前。是代码检查、测试运行的好时机。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>prepare-commit-msg</td>
      <td>启动提交信息编辑器之前，默认信息被创建之后运行。可以在这里修改默认提交信息。</td>
      <td>filepath commitType SHA-1</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>commit-msg</td>
      <td>输入提交信息后，执行提交前发生。可以在这里检查提交信息是否规范，也可以修改提交信息。</td>
      <td>filepath</td>
      <td>是</td>
    </tr>
    <tr>
      <td>提交工作流钩子</td>
      <td>post-commit</td>
      <td>整个提交完成后。一般用于发生通知，例如邮件通知提交等（但是建议在服务器端 post-receive 钩子中做）。</td>
      <td>\</td>
      <td>否</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>applypatch-msg</td>
      <td>生成补丁提交信息后，应用补丁前。可用来检查补丁提交信息是否规范。</td>
      <td>mergeFilename</td>
      <td>是</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>pre-applypatch</td>
      <td>运行于应用补丁后，产生提交对象之前。因此和 pre-commit 一样是代码检查、测试运行的好时机。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>电子邮件工作流钩子</td>
      <td>post-applypatch</td>
      <td>整个提交完成后。同 post-commit 一样是通知的好时机。</td>
      <td>\</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>pre-rebase</td>
      <td>运行于变基前。</td>
      <td>\</td>
      <td>是</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-rewrite</td>
      <td>被会替换提交记录的命令所触发。如<code>git commit --amend</code></td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-checkout</td>
      <td>在 git checkout 成功运行后。</td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>post-merge</td>
      <td>在 git merge 成功运行后。</td>
      <td>commandName</td>
      <td>否</td>
    </tr>
    <tr>
      <td>其它客户端钩子</td>
      <td>pre-push</td>
      <td>更新了远程引用但是未推送本地提交前。</td>
      <td>originBranchName HEAD</td>
      <td>是</td>
    </tr>
  </tbody>
</table>
<p>参考：</p>
<ul>
  <li>可中止：钩子以非 0 结束码退出则中止 Git 操作，以 0 结束码退出则正常执行 Git 操作，后面的服务器端钩子同理。</li>
</ul>
<ul>
  <li>filepath：提交信息存储文件路径<code>.git/COMMIT_EDITMSG</code>。</li>
  <li>commitType：提交类型，使用<code>git commit</code>提交时为空，使用<code>git commit -m</code>提交时为<code>message</code>，使用<code>git commit -c</code>提交时为<code>commit</code>，可以通过<code>git commit -h</code>查看对应的提交类型。</li>
  <li>SHA-1：关联的提交的哈希字符串，例如使用 git commit --amend 提交时为上一次提交的哈希。</li>
  <li>mergeFilename：请求合并信息的临时文件的名字。</li>
  <li>commandName：触发的命令名。</li>
  <li>originBranchName ： 远程分支名。</li>
  <li>HEAD：本地分支最新提交的引用。</li>
</ul>
<blockquote>
  <p>提交工作流钩子是一般我们常用到的，电子邮件工作流只会在通过电子邮件推送代码的工作流中会用到。</p>
</blockquote>
<h3 id="服务器端钩子">服务器端钩子</h3>
<p>服务器端钩子主要在推送到达到服务器之前和之后触发。</p>
<table>
  <thead>
    <tr>
      <th>钩子类型</th>
      <th>钩子名称</th>
      <th>触发时机</th>
      <th>钩子参数</th>
      <th>可终止</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>服务器端钩子</td>
      <td>pre-receive</td>
      <td>客户端推送到达前，非 0 值退出则拒绝</td>
      <td>pushRef</td>
      <td>是</td>
    </tr>
    <tr>
      <td>服务器端钩子</td>
      <td>update</td>
      <td>和 pre-receive，区别时如果提交包含多个分支，则会在每个分支都运行一次，而 pre-receive 只会运行一次。</td>
      <td>branchName lastSHA-1 thisSHA-1</td>
      <td>是</td>
    </tr>
    <tr>
      <td>服务器端钩子</td>
      <td>post-receive</td>
      <td>推送完成后。常用于邮件通知，持续集成。</td>
      <td>pushRef</td>
      <td>否</td>
    </tr>
  </tbody>
</table>
<p>参数解释：</p>
<ul>
  <li>pushRef：推送的引用。</li>
  <li>branchName：引用的名字（分支）。</li>
  <li>lastSHA-1：推送前的引用指向的内容的 SHA-1 值</li>
  <li>thisSHA-1：用户本次推送的内容的 SHA-1 值</li>
</ul>
<h3 id="使用-husky">使用 husky</h3>
<p><a href="https://github.com/typicode/husky">husky</a>是一个 npm 包，让你可以更加简单的管理 hooks。</p>
<h4 id="husky-安装">husky 安装</h4>
<p>> v0.14: <code>yarn add -D husky@next</code></p>
<p>&#x3C;=0.14: <code>yarn add -D husky</code></p>
<h4 id="husky-使用">husky 使用</h4>
<p>husky 使用比较简单，支持所有的客户端 hooks。</p>
<blockquote>
  <p>husky 默认情况下 husky 要求<code>package.json</code>和<code>.git</code>在同级目录，但是可以通过配置支持子路径。</p>
</blockquote>
<p>> v0.14:</p>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"husky"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"hooks"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"npm test"</span><span class="token punctuation">,</span>
      <span class="token property">"prepare-commit-msg"</span><span class="token operator">:</span> <span class="token string">"node prepare-commit-msg.js ${GIT_PARAMS}"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>&#x3C;=0.14:</p>
<div class="remark-highlight">
  <pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"pre-commit"</span><span class="token operator">:</span> <span class="token string">"npm test"</span><span class="token punctuation">,</span>
    <span class="token property">"prepare-commit-msg"</span><span class="token operator">:</span> <span class="token string">"node prepare-commit-msg.js ${GIT_PARAMS}"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<blockquote>
  <p>环境变量<code>GIT_PARAMS</code>，是当前钩子接收到的参数使用空格连接而成的字符串。</p>
  <p>node.js 中可通过 progress.env.GIT_PARAMS 取得。</p>
</blockquote>
<h4 id="husky-原理">husky 原理</h4>
<blockquote>
  <p>以> 0.14 版本代码为例,老版本同理</p>
</blockquote>
<p>husky 安装的时候会自动在<code>.git/hooks</code>,下生成所有的客户端钩子。每一个钩子的代码完全一样，代码：</p>
<div class="remark-highlight">
  <pre class="language-shell"><code class="language-shell"><span class="token shebang important">#!/bin/sh -e</span>
<span class="token comment"># husky</span>
<span class="token comment"># v0.15.0-rc.8 win32</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">GIT_PARAMS</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$*</span>"</span>
<span class="token function">node</span> ./node_modules/husky/lib/runner/bin <span class="token variable"><span class="token variable">`</span><span class="token function">basename</span> <span class="token string">"<span class="token variable">$0</span>"</span><span class="token variable">`</span></span>
</code></pre>
</div>
<p>上面的代码是一段 shell 脚本，第 5 行将 shell 脚本接收到的所有参数（<code>$*</code>）导出为环境变量<code>GIT_PARAMS</code>。</p>
<p>然后通过 node 执行了<code>./node_modules/husky/lib/runner/bin</code>脚本文件，代码：</p>
<div class="remark-highlight">
  <pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> index <span class="token keyword">from</span> <span class="token string">"./"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token function">index</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p><code>bin.js</code>使用当前进程的所有命令行参数构成的数组（process.argv）作为参数，调用了 index.js 的默认导出函数，并将函数返回值作为进程结束码*（当钩子允许中止时，结束码为非 0 时将中止当前 Git 操作，为 0 正常退出）*。</p>
<p><em>index.js 代码如下：</em></p>
<div class="remark-highlight">
  <pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> cosmiconfig <span class="token keyword">from</span> <span class="token string">"cosmiconfig"</span><span class="token punctuation">;</span> <span class="token comment">// 这一行代码貌似是多余的，后面没用到</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> execa <span class="token keyword">from</span> <span class="token string">"execa"</span><span class="token punctuation">;</span> <span class="token comment">// 第三方包，node.js的child_process的promise封装</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> readPkg <span class="token keyword">from</span> <span class="token string">"read-pkg"</span><span class="token punctuation">;</span> <span class="token comment">// 第三方包，读取package.json并返回配置对象</span>
<span class="token keyword">import</span> getConf <span class="token keyword">from</span> <span class="token string">"../getConf"</span><span class="token punctuation">;</span> <span class="token comment">// 第三方包，通过调用第三方包cosmiconfig读取并返回配置对象</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">,</span> hookName <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pkg <span class="token operator">=</span> readPkg<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">getConf</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> command<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span>
    config <span class="token operator">&#x26;&#x26;</span> config<span class="token punctuation">.</span>hooks <span class="token operator">&#x26;&#x26;</span> config<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookName<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> oldCommand<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span>
    pkg <span class="token operator">&#x26;&#x26;</span> pkg<span class="token punctuation">.</span>scripts <span class="token operator">&#x26;&#x26;</span> pkg<span class="token punctuation">.</span>scripts<span class="token punctuation">[</span>hookName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">husky > </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (node </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      execa<span class="token punctuation">.</span><span class="token function">shellSync</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token punctuation">,</span> stdio<span class="token operator">:</span> <span class="token string">"inherit"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Warning: Setting </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> script in package.json > scripts will be deprecated in v1.0</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please move it to husky.hooks in package.json, a .huskyrc file, or a husky.config.js file</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Or run ./node_modules/.bin/husky-upgrade for automatic update</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">See https://github.com/typicode/husky/tree/dev for usage</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">husky > </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (node </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      execa<span class="token punctuation">.</span><span class="token function">shellSync</span><span class="token punctuation">(</span>oldCommand<span class="token punctuation">,</span> <span class="token punctuation">{</span> cwd<span class="token punctuation">,</span> stdio<span class="token operator">:</span> <span class="token string">"inherit"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> noVerifyMessage <span class="token operator">=</span>
      hookName <span class="token operator">===</span> <span class="token string">"prepare-commit-msg"</span>
        <span class="token operator">?</span> <span class="token string">"(cannot be bypassed with --no-verify due to Git specs)"</span>
        <span class="token operator">:</span> <span class="token string">"(add --no-verify to bypass)"</span><span class="token punctuation">;</span>

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">husky > </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook failed </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noVerifyMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<p>代码比较清晰，即通过参数解构获取到当前的<code>hookName</code>，通过 <code>getConf</code><em>(调用 cosmiconfig 包)</em> 和 <code>read-pkg</code>包从 package.json 中获取 hookName 对应的 hooks 命令，然后通过 execa.shellSync 同步执行获取到的 hook 命令，执行成功返回 0，执行错误返回 1（作为上层<code>bin.js</code>的错误码来结束进程）。</p>
<blockquote>
  <p>为什么通过这两个不同的包来获取 package.json 文件中的配置？</p>
  <p>从这两个包的区别来看应该是为了在新版本中支持除 package.json 外其他的配置文件中配置 hooks，因为 cosmiconfig 支持除 package.json 文件外其他的配置文件，read-pkg 只支持 package.json。</p>
</blockquote>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[React事件绑定]]></title>
            <link>https://jiangwenyang.com/posts/React事件绑定</link>
            <guid>https://jiangwenyang.com/posts/React事件绑定</guid>
            <pubDate>Wed, 20 Dec 2017 00:00:00 GMT</pubDate>
            <description><![CDATA[简单介绍及对比了React事件绑定的几种方式]]></description>
            <content:encoded><![CDATA[
<p>
  由于类的方法默认不会绑定 this，因此在调用的时候如果忘记绑定，this 的值将会是 undefined。
  通常如果不是直接调用，应该为方法绑定 this。绑定方式有以下几种：
</p>
<h2 id="1-在构造函数中使用-bind-绑定-this">1. 在构造函数中使用 bind 绑定 this</h2>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Click</span> me<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="2-在调用的时候使用-bind-绑定-this">2. 在调用的时候使用 bind 绑定 this</h2>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Click</span> me<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="3-在调用的时候使用箭头函数绑定-this">3. 在调用的时候使用箭头函数绑定 this</h2>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Click</span> me<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="4-使用属性初始化器语法绑定-this实验性">4. 使用属性初始化器语法绑定 this(实验性)</h2>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">Button</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"this is:"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Click</span> me<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h2 id="比较">比较</h2>
<p><strong>方式 1</strong> 在类构造函数中绑定 this，调用的时候不需要再绑定</p>
<ul>
  <li><strong>优点：</strong> 只会生成一个方法实例，并且绑定一次之后如果多次用到这个方法也不需要再绑定。</li>
  <li><strong>缺点：</strong> 即使不用到 state，也需要添加类构造函数来绑定 this，代码量多一点。。。</li>
</ul>
<p><strong>方式 2</strong> 和 <strong>方式 3</strong> 都是在调用的时候再绑定 this。</p>
<ul>
  <li><strong>优点：</strong> 写法比较简单，当组件中没有 state 的时候就不需要添加类构造函数来绑定 this</li>
  <li><strong>缺点：</strong> 每一次调用的时候都会生成一个新的方法实例，因此对性能有影响，并且当这个函数作为属性值传入低阶组件的时候，这些组件可能会进行额外的重新渲染，因为每一次都是新的方法实例作为的新的属性传递。</li>
</ul>
<p><strong>方式 4：</strong> 利用属性初始化语法，将方法初始化为箭头函数，因此在创建函数的时候就绑定了 this。</p>
<ul>
  <li><strong>优点：</strong> 创建方法就绑定 this，不需要在类构造函数中绑定，调用的时候不需要再作绑定。结合了<strong>方式 1</strong>、<strong>方式 2</strong>、<strong>方式 3</strong> 的优点</li>
  <li><strong>缺点：</strong> 目前仍然是实验性语法，需要用 babel 转译</li>
</ul>
<h2 id="总结">总结</h2>
<p>方式 1 是官方推荐的绑定方式，也是性能最好的方式。方式 2 和方式 3 会有性能影响并且当方法作为属性传递给子组件的时候会引起重渲问题。方式 4 目前属于实验性语法，但是是最好的绑定方式，需要结合 bable 转译</p>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[React高价组件（HOC）]]></title>
            <link>https://jiangwenyang.com/posts/React高价组件（HOC）</link>
            <guid>https://jiangwenyang.com/posts/React高价组件（HOC）</guid>
            <pubDate>Wed, 20 Dec 2017 00:00:00 GMT</pubDate>
            <description><![CDATA[简单介绍什么是React高阶组件]]></description>
            <content:encoded><![CDATA[
<h2 id="react-高阶组件hoc">React 高阶组件（HOC）</h2>
<blockquote>
  <p>
    含义： 高阶组件就是一个 React 组件包裹着另外一个 React 组件
    用处：通过函数向现有组件类添加逻辑或者改变现有组件的行为
  </p>
</blockquote>
<p>通常有两种实现高阶组件的方式：</p>
<ul>
  <li>Props Proxy（属性代理）：高阶组件对传给其中的组件的 props 进行管理</li>
  <li>Inheritance Inversion（反向继承）：高阶组件继承包裹其中的组件</li>
</ul>
<h3 id="props-proxy">Props Proxy</h3>
<p>高阶组件通常使用函数来实现，而实现一个 Props Proxy 方式的高阶组件类似于：</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">ChildComponent</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">Pphoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ChildComponent</span> <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h4 id="props-proxy-的特点">Props Proxy 的特点</h4>
<ul>
  <li>可以操作 props（CRUD）</li>
  <li>可以通过 Refs 访问到被代理的组件实例</li>
  <li>可以提取 state</li>
  <li>可以给被代理组件定义样式，通过使用其他元素包裹</li>
</ul>
<h5 id="操作-props">操作 props</h5>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">ChildComponent</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">Pphoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> newProps<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"tom"</span>
        <span class="token punctuation">}</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ChildComponent</span> <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>newProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h5 id="通过-refs-获取代理组件实例">通过 Refs 获取代理组件实例</h5>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">ChildComponent</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">Pphoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
        <span class="token function">proxyComponet</span><span class="token punctuation">(</span><span class="token parameter">proxyComponetInstance</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            proxyComponetInstance<span class="token punctuation">.</span><span class="token method function property-access">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword control-flow">return</span>
            <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ChildComponent</span>
                <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span>
                ref<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">proxyComponet</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            <span class="token operator">/</span><span class="token operator">></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<blockquote>
  <p>
    ref callback
    当给一个组件定义 ref 为一个 callback 时，callback 会在组件被挂载后立即执行，被引用的组件的实例会作为参数传递，然后就可以在回调中使用这个组件实例。
  </p>
</blockquote>
<h5 id="提取-state">提取 state</h5>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">ChildComponent</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">Pphoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">onChangeName</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newProps <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        <span class="token literal-property property">onchange</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onChangeName</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ChildComponent</span> <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>newProps<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token constant">HOC</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>input name<span class="token operator">=</span><span class="token string">"name"</span> <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h5 id="使用其他元素包裹">使用其他元素包裹</h5>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">ChildComponent</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">Pphoc</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
                <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>background<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
                    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ChildComponent</span> <span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
                <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h3 id="inheritance-inversion">Inheritance Inversion</h3>
<p>反向继承通过返回一个继承自传入组件的新组件的方式实现：</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">childComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">NewComponent</span> <span class="token keyword">extends</span> <span class="token class-name">childComponent</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h4 id="inheritance-inversion-的特点">Inheritance Inversion 的特点</h4>
<ul>
  <li>操作 state</li>
  <li>渲染劫持</li>
</ul>
<h5 id="操作-state">操作 state</h5>
<p>因为返回的组件是继承自传入的组件，因此可以直接使用 this.props 和 this.state 读取传入组件的 props 和 state,并且可以修改 state</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">childComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">NewComponent</span> <span class="token keyword">extends</span> <span class="token class-name">childComponent</span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
          <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
          <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
          <span class="token punctuation">{</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
<h5 id="渲染劫持">渲染劫持</h5>
<p>可以保存传入组件的 render()结果，然后返回新的 render 结果。</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">HOC</span><span class="token punctuation">(</span><span class="token parameter">childComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">class</span> <span class="token class-name">NewComponent</span> <span class="token keyword">extends</span> <span class="token class-name">childComponent</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> tree<span class="token operator">=</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//保存render结果</span>
      <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
           <span class="token keyword">const</span> newProps<span class="token operator">=</span><span class="token punctuation">{</span>
               name<span class="token operator">=</span><span class="token string">"tom"</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">const</span> props<span class="token operator">=</span><span class="token punctuation">{</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token spread operator">...</span>newProps<span class="token punctuation">}</span><span class="token punctuation">;</span>
           <span class="token keyword">const</span> newTree <span class="token operator">=</span> <span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">cloneElement</span><span class="token punctuation">(</span>tree<span class="token punctuation">,</span> props<span class="token punctuation">,</span> tree<span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[基于karma的前端单元测试]]></title>
            <link>https://jiangwenyang.com/posts/基于karma的前端单元测试</link>
            <guid>https://jiangwenyang.com/posts/基于karma的前端单元测试</guid>
            <pubDate>Wed, 20 Dec 2017 00:00:00 GMT</pubDate>
            <description><![CDATA[简单介绍如何配置karma和webpack来进行前端测试]]></description>
            <content:encoded><![CDATA[
<h2 id="karma--karma-webpack">karma + karma-webpack</h2>
<ul>
  <li>开发语言：typescript + react</li>
  <li>测试平台：karma</li>
  <li>测试框架：mocha</li>
  <li>断言库：chai</li>
  <li>测试桩：sinon</li>
  <li>打包|编译工具：karma-webpack | karma-typescript</li>
  <li>测试覆盖率：istanbul-instrumenter-loader</li>
</ul>
<p>因为开发语言使用的是 typescript，因此需要编译之后才能在浏览器上跑，但是编译后加入大量的 polyfill 导致覆盖率不准确的问题比较麻烦。</p>
<h3 id="不用karma-typescript">不用<a href="https://github.com/monounity/karma-typescript">karma-typescript</a>？</h3>
<p>
  利用 karma-typescript 直接运行 typescript 编写的单元测试而不用进行额外的编译，并且集成了 karma-coverage 和 Istanbul 进行代码覆盖率统计。
  缺点是每个测试文件和源文件都需要通过 srcipt 标签引入并串行执行，用例太多时浏览器性能有影响。并且不支持图像资源、字体资源等的引入。
</p>
<p>karma-typescript 支持的 transform：</p>
<ul>
  <li><a href="https://github.com/monounity/karma-typescript-angular2-transform">karma-typescript-angular2-transform</a></li>
  <li><a href="https://github.com/monounity/karma-typescript-cssmodules-transform">karma-typescript-cssmodules-transform</a></li>
  <li><a href="https://github.com/monounity/karma-typescript-es6-transform">karma-typescript-es6-transform</a></li>
  <li><a href="https://github.com/monounity/karma-typescript-postcss-transform">karma-typescript-postcss-transform</a></li>
</ul>
<p>因此在不涉及到图像资源等非 css 外部资源引用时，使用 karma-typescript 进行测试是比较好的，因此可以考虑使用 karma-typescript 进行 API 的测试。</p>
<p><strong>安装：</strong></p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -D karma-typescript
</code></pre>
</div>
<p><strong>karma-conf.js 配置</strong></p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">frameworks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jasmine"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"src/**/*.ts"</span><span class="token punctuation">,</span> <span class="token comment">// *.tsx for React Jsx</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"**/*.ts"</span><span class="token operator">:</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">,</span> <span class="token comment">// *.tsx for React Jsx</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">reporters</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"progress"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">browsers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Chrome"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>
  这是 karma-typescript 的官方配置 demo，但是这样配置会将测试用例的覆盖率也算进来。
  官方的<a href="https://github.com/monounity/karma-typescript/blob/master/cookbook.md">cookbook</a>项目上给出了测试代码分离的 demo
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">frameworks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jasmine"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">"src/**/*.ts"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">"test/**/*.ts"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">"src/**/*.ts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"karma-typescript"</span><span class="token punctuation">,</span> <span class="token string">"coverage"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"test/**/*.ts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token literal-property property">reporters</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"progress"</span><span class="token punctuation">,</span> <span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token literal-property property">browsers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Chrome"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>当使用<code>coverage</code>的时候，只有使用<code>coverage</code>预编译的代码会算入覆盖率中，上面的 demo 中只有<code>src</code>目录下的代码会被统计覆盖率，<code>test</code>目录下的测试文件则不会被统计。</p>
<p><strong>陷阱：</strong></p>
<blockquote>
  <p>ts.config.json 中如果"files"和"include"都没有被指定，编译器默认包含当前目录和子目录下所有的 TypeScript 文件（.ts, .d.ts 和 .tsx）。编译 d.ts 文件会报错，因此在 karma-conf.js 文件中使用 exclude 排除 d.ts 文件。-- <a href="https://www.tslang.cn/docs/handbook/tsconfig-json.html">https://www.tslang.cn/docs/handbook/tsconfig-json.html</a></p>
</blockquote>
<h3 id="karma-webpack--istanbul-instrumenter-loader">karma-webpack + istanbul-instrumenter-loader</h3>
<p>
  <a href="https://github.com/webpack-contrib/karma-webpack#karma-webpack">karma-webpack</a>
  通过 karma-webpack 能在 karma 中集成 webpack，如果在项目中已经使用 webpack，那么使用 karma-webpack 可能是个更好的选择，能给直接使用原有的 webpack 配置。
  <strong>安装：</strong>
</p>
<div class="remark-highlight">
  <pre class="language-bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> karma-webpack
</code></pre>
</div>
<p><strong>使用：</strong></p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

        <span class="token literal-property property">frameworks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"mocha"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"test/**/*.ts"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"test/**/*.ts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"webpack"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 使用webpack进行编译</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">browsers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Chrome"</span><span class="token punctuation">]</span>，
        <span class="token literal-property property">webpack</span><span class="token operator">:</span><span class="token punctuation">{</span>
            module：<span class="token punctuation">{</span><span class="token punctuation">}</span>
            resolve：<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token comment">// 所有可用的webpack配置项</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>将需要编译的代码使用 webpack 预编译即可，同时因为 webpack 会自动打包依赖，因此<code>files</code>中只需要引入 test 文件，对应的被测文件会按照依赖被自动打包。</p>
<p>
  <a href="https://github.com/webpack-contrib/istanbul-instrumenter-loader">istanbul-instrumenter-loader</a>
  通过使用 webpack 插件 istanbul-instrumenter-loader 对代码进行打点，以实现代码覆盖率的统计。
</p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token literal-property property">webpack</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// karma watches the test entry points</span>
  <span class="token comment">// (you don't need to specify the entry option)</span>
  <span class="token comment">// webpack watches dependencies</span>

  <span class="token comment">// webpack configuration</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.jsx'</span><span class="token punctuation">,</span> <span class="token string">'.css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'ts-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">transpileOnly</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token group punctuation">(</span>node_modules<span class="token alternation keyword">|</span>libs<span class="token alternation keyword">|</span><span class="token special-escape escape">\.</span>test<span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span><span class="token group punctuation">)</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">//排除不需要打点的测试代码和库</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'istanbul-instrumenter-loader'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token comment">//作为后置loader使用</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">esModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//使用ES2015</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
</div>
<p>
  <strong>管理依赖</strong>
  通过上面的方式打包的文件如果指定 output 能生成单个测试套件，但是如果测试套件很多的时候会生成多个大文件。解决这个问题可以通过 webpack 的<a href="https://doc.webpack-china.org/guides/dependency-management/#require-context"><code>require.context()</code></a> 解决，
  require 能定义 require 的上下文，并且搜索目录，将满足正则的文件进行处理，返回一个包含两个方法 keys()和 resolve()以及一个属性 id 的方法。
</p>
<p><em>新建 test.js</em></p>
<div class="remark-highlight">
  <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 导入所有测试用例</span>
<span class="token keyword">const</span> testsContext <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token method function property-access">context</span><span class="token punctuation">(</span><span class="token string">"./src"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex"><span class="token special-escape escape">\.</span>test<span class="token special-escape escape">\.</span>ts<span class="token anchor function">$</span></span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
testsContext<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span>testsContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>然后在<code>karma.conf.js</code>中将<code>test.js</code>作为入口</p>
<div class="remark-highlight">
  <pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>

        <span class="token literal-property property">frameworks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"mocha"</span><span class="token punctuation">,</span> <span class="token string">"karma-typescript"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"test.js"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>

        <span class="token literal-property property">preprocessors</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">"test.js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"webpack"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 使用webpack进行编译</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">browsers</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Chrome"</span><span class="token punctuation">]</span>，
        <span class="token literal-property property">webpack</span><span class="token operator">:</span><span class="token punctuation">{</span>
            module：<span class="token punctuation">{</span><span class="token punctuation">}</span>
            resolve：<span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token comment">// 所有可用的webpack配置项</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div>
<p>将多个依赖合并到一个入口，因此通过这种方式生成单个的打包文件。</p>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
        <item>
            <title><![CDATA[git ssh配置]]></title>
            <link>https://jiangwenyang.com/posts/git-ssh配置</link>
            <guid>https://jiangwenyang.com/posts/git-ssh配置</guid>
            <pubDate>Mon, 30 May 2016 18:58:33 GMT</pubDate>
            <description><![CDATA[介绍windows下如何快速配置git-ssh,一般而言 Mac 或 linux基本上也适用]]></description>
            <content:encoded><![CDATA[
<blockquote>
  <p>windows 下使用 git bash 每次执行<code>git push -u origin master</code>时都需要输入账户密码，这对于追求高效率的程序员来说是不能容忍的</p>
</blockquote>
<h2 id="解决方案">解决方案</h2>
<blockquote>
  <p>通过配置 SSH 以及在添加远程主机的时候使用 ssh 地址<code>git remote add &#x3C;主机名> &#x3C;网址></code></p>
</blockquote>
<h3 id="一检查是否已有-ssh">一、检查是否已有 ssh</h3>
<p>
  打开 git bash 输入<code>ls -al ~/.ssh</code>检查是否已有 ssh 存在
  如果存在会显示下列文件的一个或者多个
</p>
<blockquote>
  <p>
    id_dsa.pub
    id_ecdsa.pub
    id_ed25519.pub
    id_rsa.pub
  </p>
</blockquote>
<p>
  或者在系统盘下的 user/用户名/.ssh 文件夹下进行查看
  <a href="https://help.github.com/articles/checking-for-existing-ssh-keys/">参考官方帮助</a>
</p>
<h3 id="二如果不存在生成-ssh">二、如果不存在，生成 ssh</h3>
<p>
  打开 git bash 输入<code>ssh-keygen -t rsa -b 4096 -C "your_email@example.com"</code>
  例如我的用户名是 jiangwenyang，所以输入：<code>ssh-keygen -t rsa -b 4096 -C "jiangwenyang"</code>
  <a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/">参考官方帮助</a>
</p>
<h3 id="三将-ssh-私钥添加到-ssh-agent">三、将 ssh 私钥添加到 ssh-agent</h3>
<ul>
  <li>打开 git bash</li>
  <li><code>eval "$(ssh-agent -s)"</code>打开 ssh-agent</li>
  <li><code>ssh-add ~/.ssh/id_rsa</code>添加 ssh key 到 ssh-agent</li>
</ul>
<p><a href="https://help.github.com/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent/">参考官方帮助</a></p>
<h3 id="四添加-ssh-公钥到-github-账户">四、添加 ssh 公钥到 github 账户</h3>
<ul>
  <li>
    复制公钥
    打开<code>/user/用户名/.ssh</code>文件夹下面以<code>.pub</code>为后缀的文件，复制其中的内容
  </li>
  <li>添加到 github 设置中
    <ul>
      <li>网页打开 github，点击** settings **，进入个人设置页面</li>
      <li>点击<strong>SSH and GPG keys</strong>在右边的页面点击** New SSH Key **</li>
      <li>其中<strong>title</strong>字段为用户自定义字段，对 ssh-key 进行描述方便分辨，<strong>key</strong>字段为我们复制的公钥内容，粘贴即可</li>
    </ul>
  </li>
</ul>
<p><a href="https://help.github.com/articles/adding-a-new-ssh-key-to-your-github-account/">参考官方帮助</a></p>
<h3 id="五大功告成重新打开-git-bash-进行-push-便不需要输入用户名密码了">五、大功告成，重新打开 git bash 进行 push 便不需要输入用户名密码了</h3>
]]></content:encoded>
            <author>u19950930@gmail.com (Jiang Wenyang)</author>
        </item>
    </channel>
</rss>